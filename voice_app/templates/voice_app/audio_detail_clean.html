<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì˜¤ë””ì˜¤ íŒŒì¼ ìƒì„¸ ì •ë³´</title>
  <!-- WaveSurfer.js CDN -->
  <script src="https://unpkg.com/wavesurfer.js@7"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 40px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .back-button {
      display: inline-block;
      margin-bottom: 30px;
      background-color: #6c757d;
      color: white;
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 5px;
      font-size: 14px;
    }

    .back-button:hover {
      background-color: #5a6268;
    }

    h1 {
      color: #333;
      border-bottom: 3px solid #007bff;
      padding-bottom: 10px;
      margin-bottom: 30px;
    }

    .section {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      font-size: 14px;
      margin: 5px;
    }

    .btn-primary { background-color: #007bff; }
    .btn-success { background-color: #28a745; }
    .btn-warning { background-color: #ffc107; color: #333; }
    .btn-danger { background-color: #dc3545; }

    .btn:hover { opacity: 0.9; }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .info-item {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #007bff;
    }

    .info-item h3 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 16px;
    }

    .info-item p {
      margin: 0;
      color: #666;
      font-size: 16px;
    }

    /* WaveSurfer.js ìŠ¤íƒ€ì¼ */
    #waveform {
      width: 100%;
      height: 120px;
      background-color: white;
      border-radius: 5px;
      border: 1px solid #ddd;
      margin-bottom: 15px;
    }

    .waveform-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .time-display {
      font-family: monospace;
      font-size: 14px;
      color: #666;
      margin: 0 10px;
    }

    .volume-control {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .volume-control input {
      width: 80px;
    }

    /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
    .alert {
      padding: 12px 16px;
      margin-bottom: 20px;
      border-radius: 5px;
      position: relative;
    }

    .alert-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-warning {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .alert-danger {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* ë±ƒì§€ ìŠ¤íƒ€ì¼ */
    .badge {
      display: inline-block;
      padding: 0.35em 0.65em;
      font-size: 0.75em;
      font-weight: 700;
      line-height: 1;
      text-align: center;
      white-space: nowrap;
      vertical-align: baseline;
      border-radius: 0.375rem;
    }

    .bg-success { background-color: #28a745 !important; color: white; }
    .bg-warning { background-color: #ffc107 !important; color: #333; }
    .bg-danger { background-color: #dc3545 !important; color: white; }
    .bg-secondary { background-color: #6c757d !important; color: white; }

    /* ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ */
    .spinner-border {
      width: 1rem;
      height: 1rem;
      border: 0.125em solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      animation: spinner-border 0.75s linear infinite;
    }

    @keyframes spinner-border {
      to { transform: rotate(360deg); }
    }

    /* Alignment ì‹œê°í™” ìŠ¤íƒ€ì¼ */
    #alignmentTimeline {
      height: 60px;
      background-color: #f8f9fa;
      border-radius: 3px;
      margin-bottom: 15px;
      position: relative;
      overflow: hidden;
      border: 1px solid #ddd;
    }

    #alignmentText {
      background-color: #f8f9fa;
      padding: 10px;
      border-radius: 3px;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.8;
      border: 1px solid #ddd;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="{% url 'voice_app:audio_list' %}" class="back-button">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    
    <h1>ğŸµ ì˜¤ë””ì˜¤ íŒŒì¼ ìƒì„¸ ì •ë³´</h1>

    <!-- ë©”ì‹œì§€ í‘œì‹œ -->
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    <!-- WaveSurfer.js ì‹œê°í™” -->
    <div class="section">
      <h3>ğŸµ ì˜¤ë””ì˜¤ íŒŒí˜• ì‹œê°í™”</h3>
      <div id="waveform"></div>
      <div class="waveform-controls">
        <button id="playPauseBtn" class="btn btn-success">â–¶ï¸ ì¬ìƒ</button>
        <button id="stopBtn" class="btn btn-danger">â¹ï¸ ì •ì§€</button>
        <div class="time-display">
          <span id="currentTime">00:00</span> / <span id="totalTime">00:00</span>
        </div>
        <div class="volume-control">
          <label for="volumeSlider">ë³¼ë¥¨:</label>
          <input type="range" id="volumeSlider" min="0" max="100" value="50">
        </div>
      </div>
    </div>

    <!-- ì „ì‚¬ ë‚´ìš© (ì½ê¸° ì „ìš©) -->
    <div class="section">
      <h3>ğŸ“ ì „ì‚¬ ë‚´ìš©</h3>
      <div style="background-color: white; border: 1px solid #ddd; border-radius: 5px; min-height: 100px; padding: 15px; margin-bottom: 15px;">
        {% if audio.manual_transcript %}
          <div style="font-size: 14px; line-height: 1.6; color: #333; white-space: pre-wrap; word-wrap: break-word;">
            {{ audio.manual_transcript }}
            {% if audio.manual_transcript != audio.transcript %}
              <div style="margin-top: 10px; font-size: 12px; color: #666;"><i class="fas fa-edit"></i> ìˆ˜ë™ í¸ì§‘ë¨</div>
            {% endif %}
          </div>
        {% elif audio.transcript %}
          <div style="font-size: 14px; line-height: 1.6; color: #333; white-space: pre-wrap; word-wrap: break-word;">
            {{ audio.transcript }}
          </div>
        {% else %}
          <div style="display: flex; align-items: center; justify-content: center; min-height: 80px; font-style: italic; color: #666;">
            ì•„ì§ ì „ì‚¬ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. Whisper ì „ì‚¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìë™ ì „ì‚¬ë¥¼ ì‹œì‘í•˜ê±°ë‚˜ ì•„ë˜ì—ì„œ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.
          </div>
        {% endif %}
      </div>
      
      <!-- Whisper ì „ì‚¬ ë²„íŠ¼ê³¼ ìƒíƒœ í‘œì‹œ -->
      <div style="margin-top: 15px;">
        <a href="{{ audio.audio_file.url }}" download class="btn btn-primary">ğŸ’¾ ë‹¤ìš´ë¡œë“œ</a>
        
        {% if audio.status == 'processing' %}
          <button class="btn btn-warning" disabled>
            <span class="spinner-border spinner-border-sm" role="status"></span>
            ğŸ§  ì „ì‚¬ ì§„í–‰ ì¤‘...
          </button>
        {% else %}
          <form method="POST" action="{% url 'voice_app:transcribe_single_audio' audio.id %}" style="display: inline;" id="transcribeForm">
            {% csrf_token %}
            <button type="submit" class="btn btn-success" id="transcribeBtn">ğŸ§  Whisper ì „ì‚¬</button>
          </form>
        {% endif %}
        
        <!-- ì „ì‚¬ ìƒíƒœ í‘œì‹œ -->
        {% if audio.status == 'completed' %}
          <span class="badge bg-success">âœ… ì „ì‚¬ ì™„ë£Œ</span>
        {% elif audio.status == 'processing' %}
          <span class="badge bg-warning">â³ ì „ì‚¬ ì§„í–‰ ì¤‘</span>
        {% elif audio.status == 'failed' %}
          <span class="badge bg-danger">âŒ ì „ì‚¬ ì‹¤íŒ¨</span>
        {% else %}
          <span class="badge bg-secondary">â¸ï¸ ì „ì‚¬ ëŒ€ê¸°</span>
        {% endif %}
      </div>
    </div>

    <!-- WhisperX Forced Alignment ì„¹ì…˜ -->
    <div class="section">
      <h3>ğŸ¯ WhisperX Forced Alignment</h3>
      <div style="margin-bottom: 15px;">
        <p>WhisperXë¥¼ ì‚¬ìš©í•˜ì—¬ ì „ì‚¬ì™€ í•¨ê»˜ ë‹¨ì–´/ë¬¸ì¥ ë‹¨ìœ„ì˜ ì •í™•í•œ ì‹œê°„ ì •ë³´(forced alignment)ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        
        <!-- Alignment ìƒíƒœ í‘œì‹œ -->
        <div style="margin: 10px 0;">
          {% if audio.alignment_status == 'completed' %}
            <span class="badge bg-success">âœ… Alignment ì™„ë£Œ</span>
          {% elif audio.alignment_status == 'processing' %}
            <span class="badge bg-warning">â³ Alignment ì§„í–‰ ì¤‘</span>
          {% elif audio.alignment_status == 'failed' %}
            <span class="badge bg-danger">âŒ Alignment ì‹¤íŒ¨</span>
          {% else %}
            <span class="badge bg-secondary">â¸ï¸ Alignment ëŒ€ê¸°</span>
          {% endif %}
        </div>
        
        <!-- Alignment ì‹¤í–‰ ë²„íŠ¼ -->
        <div>
          {% if audio.alignment_status == 'processing' %}
            <button class="btn btn-warning" disabled>
              <span class="spinner-border spinner-border-sm" role="status"></span>
              ğŸ¯ Alignment ì§„í–‰ ì¤‘...
            </button>
          {% else %}
            <form method="POST" action="{% url 'voice_app:whisperx_align_audio' audio.id %}" style="display: inline;" id="alignmentForm">
              {% csrf_token %}
              <button type="submit" class="btn btn-primary" id="alignmentBtn">ğŸ¯ WhisperX Alignment ì‹œì‘</button>
            </form>
          {% endif %}
          
          {% if audio.alignment_data and audio.alignment_status == 'completed' %}
            <button class="btn btn-success" onclick="showAlignmentVisualization()">ğŸ‘ï¸ Alignment ê²°ê³¼ ë³´ê¸°</button>
          {% endif %}
        </div>
      </div>
      
      <!-- Alignment ì‹œê°í™” ì˜ì—­ -->
      <div id="alignmentVisualization" style="display: none; margin-top: 20px;">
        <h4>ğŸµ Alignment ì‹œê°í™”</h4>
        <div style="background-color: white; border: 1px solid #ddd; border-radius: 5px; padding: 15px;">
          <div id="alignmentTimeline"></div>
          <div style="margin-bottom: 15px;">
            <button class="btn btn-primary" onclick="playAlignmentSegment()">â–¶ï¸ ì¬ìƒ</button>
            <button class="btn btn-secondary" onclick="pauseAlignment()">â¸ï¸ ì¼ì‹œì •ì§€</button>
            <select id="alignmentModeSelect" onchange="changeAlignmentMode()" style="margin-left: 10px; padding: 5px;">
              <option value="segments">ë¬¸ì¥ ë‹¨ìœ„</option>
              <option value="words">ë‹¨ì–´ ë‹¨ìœ„</option>
            </select>
          </div>
          <div id="alignmentText"></div>
        </div>
      </div>
    </div>

    <!-- ì „ì‚¬ ìˆ˜ì • ë‚´ìš© -->
    <div class="section">
      <h3>âœï¸ ì „ì‚¬ ìˆ˜ì • ë‚´ìš©</h3>
      <form method="POST" action="{% url 'voice_app:update_transcription' audio.id %}">
        {% csrf_token %}
        <div class="form-group">
          <textarea name="manual_transcript" placeholder="ì „ì‚¬ ë‚´ìš©ì„ ìˆ˜ì •í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”..." style="min-height: 100px;">{{ audio.manual_transcript|default:audio.transcript|default_if_none:"" }}</textarea>
        </div>
        <button type="submit" class="btn btn-success">ğŸ’¾ ìˆ˜ì • ë‚´ìš© ì €ì¥</button>
      </form>
    </div>

    <!-- ë©”íƒ€ ì •ë³´ í¸ì§‘ -->
    <div class="section">
      <h3>âœï¸ ë©”íƒ€ ì •ë³´ í¸ì§‘</h3>
      <form method="POST" action="{% url 'voice_app:update_audio_metadata' audio.id %}">
        {% csrf_token %}
        <div class="form-row">
          <div class="form-group">
            <label for="gender">ì„±ë³„</label>
            <select name="gender" id="gender">
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              <option value="male" {% if audio.gender == 'male' %}selected{% endif %}>ë‚¨ì„±</option>
              <option value="female" {% if audio.gender == 'female' %}selected{% endif %}>ì—¬ì„±</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="age">ë‚˜ì´</label>
            <input type="text" name="age" id="age" value="{{ audio.age|default_if_none:"" }}" placeholder="ë‚˜ì´ ì…ë ¥">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="category">ì¹´í…Œê³ ë¦¬</label>
            <select name="category" id="category">
              <option value="normal" {% if audio.category == 'normal' %}selected{% endif %}>ì¼ë°˜</option>
              <option value="child" {% if audio.category == 'child' %}selected{% endif %}>ì•„ë™</option>
              <option value="senior" {% if audio.category == 'senior' %}selected{% endif %}>ì„±ì¸</option>
              <option value="atypical" {% if audio.category == 'atypical' %}selected{% endif %}>ìŒì„± ì¥ì• </option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="snr_mean">í‰ê·  SNR</label>
            <input type="number" step="0.01" name="snr_mean" id="snr_mean" value="{{ audio.snr_mean|default_if_none:"" }}" placeholder="í‰ê·  SNR ê°’">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="snr_max">ìµœëŒ€ SNR</label>
            <input type="number" step="0.01" name="snr_max" id="snr_max" value="{{ audio.snr_max|default_if_none:"" }}" placeholder="ìµœëŒ€ SNR ê°’">
          </div>
          
          <div class="form-group">
            <label for="snr_min">ìµœì†Œ SNR</label>
            <input type="number" step="0.01" name="snr_min" id="snr_min" value="{{ audio.snr_min|default_if_none:"" }}" placeholder="ìµœì†Œ SNR ê°’">
          </div>
        </div>
        
        <button type="submit" class="btn btn-warning">ğŸ“ ë©”íƒ€ ì •ë³´ ì—…ë°ì´íŠ¸</button>
        <a href="{% url 'voice_app:audio_list' %}" class="btn btn-danger">âŒ ì·¨ì†Œ</a>
      </form>
    </div>

    <!-- ê¸°ë³¸ ì •ë³´ -->
    <div class="info-grid">
      <div class="info-item">
        <h3>ğŸ“Š ì¹´í…Œê³ ë¦¬</h3>
        <p>{{ category_name }}</p>
      </div>
      
      <div class="info-item">
        <h3>ğŸ“… ì—…ë¡œë“œ ì‹œê°„</h3>
        <p>{{ audio.created_at|date:"Y-m-d H:i" }}</p>
      </div>
      
      <div class="info-item">
        <h3>ğŸš¦ ìƒíƒœ</h3>
        <p>{{ audio.get_status_display }}</p>
      </div>
      
      <div class="info-item">
        <h3>ğŸ†” íŒŒì¼ ID</h3>
        <p>{{ audio.id }}</p>
      </div>
    </div>
  </div>

  <script>
    // ì „ì—­ ë³€ìˆ˜
    let wavesurfer = null;
    let alignmentData = null;
    let currentAlignmentMode = 'segments';
    let currentSegmentIndex = 0;

    // ì‹œê°„ í¬ë§· í•¨ìˆ˜
    function formatTime(seconds) {
      if (isNaN(seconds) || seconds < 0) return '00:00';
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = Math.floor(seconds % 60);
      return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing...');
      
      // WaveSurfer ì´ˆê¸°í™”
      initWaveSurfer();
      
      // ë©”ì‹œì§€ ìë™ ë‹«ê¸°
      initMessageAutoClose();
      
      // í¼ ì´ë²¤íŠ¸ ì„¤ì •
      initFormEvents();
      
      // Alignment ìƒíƒœ í™•ì¸
      checkAlignmentStatus();
    });

    function initWaveSurfer() {
      try {
        console.log('Initializing WaveSurfer...');
        
        wavesurfer = WaveSurfer.create({
          container: '#waveform',
          waveColor: '#007bff',
          progressColor: '#28a745',
          height: 120,
          barWidth: 2,
          barGap: 1,
          responsive: true,
          normalize: true
        });

        const audioUrl = '{{ audio.audio_file.url }}';
        console.log('Loading audio:', audioUrl);
        wavesurfer.load(audioUrl);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        wavesurfer.on('ready', function() {
          console.log('WaveSurfer ready');
          const totalTime = wavesurfer.getDuration();
          document.getElementById('totalTime').textContent = formatTime(totalTime);
        });

        wavesurfer.on('audioprocess', function() {
          const currentTime = wavesurfer.getCurrentTime();
          document.getElementById('currentTime').textContent = formatTime(currentTime);
        });

        wavesurfer.on('finish', function() {
          document.getElementById('playPauseBtn').textContent = 'â–¶ï¸ ì¬ìƒ';
        });

        wavesurfer.on('error', function(error) {
          console.error('WaveSurfer error:', error);
          document.getElementById('waveform').innerHTML = '<div style="color: red; text-align: center; padding: 20px;">ì˜¤ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨: ' + error + '</div>';
        });

        // ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('playPauseBtn').addEventListener('click', function() {
          try {
            if (wavesurfer.isPlaying()) {
              wavesurfer.pause();
              this.textContent = 'â–¶ï¸ ì¬ìƒ';
            } else {
              wavesurfer.play();
              this.textContent = 'â¸ï¸ ì¼ì‹œì •ì§€';
            }
          } catch (error) {
            console.error('Play/pause error:', error);
          }
        });

        document.getElementById('stopBtn').addEventListener('click', function() {
          try {
            wavesurfer.stop();
            document.getElementById('playPauseBtn').textContent = 'â–¶ï¸ ì¬ìƒ';
          } catch (error) {
            console.error('Stop error:', error);
          }
        });

        document.getElementById('volumeSlider').addEventListener('input', function() {
          try {
            wavesurfer.setVolume(this.value / 100);
          } catch (error) {
            console.error('Volume error:', error);
          }
        });

      } catch (error) {
        console.error('WaveSurfer initialization error:', error);
        document.getElementById('waveform').innerHTML = '<div style="color: red; text-align: center; padding: 20px;">WaveSurfer ì´ˆê¸°í™” ì‹¤íŒ¨</div>';
      }
    }

    function initMessageAutoClose() {
      const alerts = document.querySelectorAll('.alert');
      alerts.forEach(function(alert) {
        setTimeout(function() {
          alert.style.opacity = '0';
          setTimeout(function() {
            alert.remove();
          }, 300);
        }, 5000);
      });
    }

    function initFormEvents() {
      // ì „ì‚¬ í¼
      const transcribeForm = document.getElementById('transcribeForm');
      const transcribeBtn = document.getElementById('transcribeBtn');

      if (transcribeForm && transcribeBtn) {
        transcribeForm.addEventListener('submit', function() {
          transcribeBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ğŸ§  ì „ì‚¬ ì§„í–‰ ì¤‘...';
          transcribeBtn.disabled = true;
          transcribeBtn.className = 'btn btn-warning';
        });
      }

      // Alignment í¼
      const alignmentForm = document.getElementById('alignmentForm');
      const alignmentBtn = document.getElementById('alignmentBtn');

      if (alignmentForm && alignmentBtn) {
        alignmentForm.addEventListener('submit', function() {
          alignmentBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ğŸ¯ Alignment ì§„í–‰ ì¤‘...';
          alignmentBtn.disabled = true;
          alignmentBtn.className = 'btn btn-warning';
        });
      }
    }

    function checkAlignmentStatus() {
      const status = '{{ audio.alignment_status }}';
      if (status === 'processing') {
        const checkInterval = setInterval(function() {
          fetch(`/api/alignment-status/{{ audio.id }}/`)
            .then(response => response.json())
            .then(data => {
              if (data.status !== 'processing') {
                location.reload();
              }
            })
            .catch(error => console.log('Status check error:', error));
        }, 5000);

        window.addEventListener('beforeunload', function() {
          clearInterval(checkInterval);
        });
      }
    }

    // Alignment ì‹œê°í™” í•¨ìˆ˜ë“¤
    function showAlignmentVisualization() {
      console.log('Showing alignment visualization');
      const container = document.getElementById('alignmentVisualization');
      
      if (container.style.display === 'none' || container.style.display === '') {
        container.style.display = 'block';
        loadAlignmentData();
      } else {
        container.style.display = 'none';
      }
    }

    function loadAlignmentData() {
      console.log('Loading alignment data...');
      fetch(`/api/alignment-data/{{ audio.id }}/`)
        .then(response => response.json())
        .then(data => {
          console.log('Alignment data response:', data);
          if (data.success) {
            alignmentData = data.data;
            renderAlignmentVisualization();
          } else {
            document.getElementById('alignmentText').innerHTML = 
              '<div style="color: red;">Alignment ë°ì´í„° ì—†ìŒ: ' + data.error + '</div>';
          }
        })
        .catch(error => {
          console.error('Alignment data load error:', error);
          document.getElementById('alignmentText').innerHTML = 
            '<div style="color: red;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message + '</div>';
        });
    }

    function renderAlignmentVisualization() {
      if (!alignmentData) {
        console.log('No alignment data to render');
        return;
      }

      console.log('Rendering alignment visualization:', alignmentData);

      const timeline = document.getElementById('alignmentTimeline');
      const textContainer = document.getElementById('alignmentText');
      
      timeline.innerHTML = '';
      textContainer.innerHTML = '';

      const data = currentAlignmentMode === 'segments' ? alignmentData.segments : alignmentData.words;
      const totalDuration = alignmentData.duration || 10;

      if (!data || data.length === 0) {
        textContainer.innerHTML = '<div style="color: orange;">Alignment ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>';
        return;
      }

      // íƒ€ì„ë¼ì¸ ì‹œê°í™”
      data.forEach((item, index) => {
        const start = item.start || 0;
        const end = item.end || start + 1;
        const duration = end - start;
        
        const startPercent = (start / totalDuration) * 100;
        const widthPercent = (duration / totalDuration) * 100;
        
        const segment = document.createElement('div');
        segment.style.position = 'absolute';
        segment.style.left = startPercent + '%';
        segment.style.width = widthPercent + '%';
        segment.style.height = '100%';
        segment.style.backgroundColor = index === currentSegmentIndex ? '#28a745' : '#007bff';
        segment.style.border = '1px solid white';
        segment.style.cursor = 'pointer';
        segment.style.opacity = '0.8';
        segment.title = `${item.text || item.word} (${start.toFixed(2)}s - ${end.toFixed(2)}s)`;
        
        segment.addEventListener('click', function() {
          selectSegment(index);
          seekToSegment(start);
        });
        
        timeline.appendChild(segment);
      });

      // í…ìŠ¤íŠ¸ í‘œì‹œ
      renderAlignmentText();
    }

    function renderAlignmentText() {
      if (!alignmentData) return;

      const textContainer = document.getElementById('alignmentText');
      const data = currentAlignmentMode === 'segments' ? alignmentData.segments : alignmentData.words;
      
      textContainer.innerHTML = '';
      
      data.forEach((item, index) => {
        const span = document.createElement('span');
        span.textContent = item.text || item.word;
        span.style.padding = '2px 4px';
        span.style.margin = '2px';
        span.style.borderRadius = '3px';
        span.style.cursor = 'pointer';
        span.style.backgroundColor = index === currentSegmentIndex ? '#28a745' : '#e9ecef';
        span.style.color = index === currentSegmentIndex ? 'white' : 'black';
        
        span.addEventListener('click', function() {
          selectSegment(index);
          seekToSegment(item.start || 0);
        });
        
        textContainer.appendChild(span);
        
        if (currentAlignmentMode === 'segments' && index < data.length - 1) {
          textContainer.appendChild(document.createTextNode(' '));
        }
      });
    }

    function selectSegment(index) {
      currentSegmentIndex = index;
      renderAlignmentVisualization();
    }

    function seekToSegment(time) {
      if (wavesurfer && wavesurfer.getDuration()) {
        wavesurfer.seekTo(time / wavesurfer.getDuration());
      }
    }

    function playAlignmentSegment() {
      if (!alignmentData || !wavesurfer) {
        console.log('Cannot play: missing data or wavesurfer');
        return;
      }

      const data = currentAlignmentMode === 'segments' ? alignmentData.segments : alignmentData.words;
      const segment = data[currentSegmentIndex];
      
      if (segment) {
        const startTime = segment.start || 0;
        const endTime = segment.end || startTime + 1;
        
        console.log(`Playing segment from ${startTime}s to ${endTime}s`);
        
        wavesurfer.seekTo(startTime / wavesurfer.getDuration());
        wavesurfer.play();
        
        setTimeout(() => {
          if (wavesurfer.isPlaying()) {
            wavesurfer.pause();
          }
        }, (endTime - startTime) * 1000);
      }
    }

    function pauseAlignment() {
      if (wavesurfer && wavesurfer.isPlaying()) {
        wavesurfer.pause();
      }
    }

    function changeAlignmentMode() {
      const select = document.getElementById('alignmentModeSelect');
      currentAlignmentMode = select.value;
      currentSegmentIndex = 0;
      renderAlignmentVisualization();
    }
  </script>
</body>
</html>
