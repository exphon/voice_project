<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì˜¤ë””ì˜¤ íŒŒì¼ ìƒì„¸ ì •ë³´</title>
  <!-- WaveSurfer.js CDN -->
  <script src="https://unpkg.com/wavesurfer.js@7"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 40px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background-color: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .back-button {
      display: inline-block;
      margin-bottom: 30px;
      background-color: #6c757d;
      color: white;
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 5px;
      font-size: 14px;
    }

    .back-button:hover {
      background-color: #5a6268;
    }

    h1 {
      color: #333;
      border-bottom: 3px solid #007bff;
      padding-bottom: 10px;
      margin-bottom: 30px;
    }

    .section {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      font-size: 14px;
      margin: 5px;
    }

    .btn-primary { background-color: #007bff; }
    .btn-success { background-color: #28a745; }
    .btn-warning { background-color: #ffc107; color: #333; }
    .btn-danger { background-color: #dc3545; }

    .btn:hover { opacity: 0.9; }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .info-item {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #007bff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .info-item h3 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-item p {
      margin: 0;
      color: #666;
      font-size: 16px;
    }

    .info-item .empty-value {
      color: #999;
      font-style: italic;
    }

    /* ì¹´í…Œê³ ë¦¬ë³„ ì •ë³´ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .category-info-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 2px solid #007bff;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 30px;
    }

    .category-info-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #007bff;
    }

    .category-info-header h3 {
      margin: 0;
      color: #007bff;
      font-size: 20px;
      font-weight: bold;
    }

    .category-badge {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      color: white;
    }

    .category-child { background-color: #17a2b8; }
    .category-senior { background-color: #6c757d; }
    .category-auditory { background-color: #28a745; }
    .category-atypical { background-color: #ffc107; color: #333; }
    .category-normal { background-color: #007bff; }

    .category-fields-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }

    .category-field-item {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #28a745;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .category-field-item .label {
      font-weight: bold;
      color: #495057;
      font-size: 14px;
      margin-bottom: 5px;
    }

    .category-field-item .value {
      color: #333;
      font-size: 16px;
    }

    /* WaveSurfer.js ìŠ¤íƒ€ì¼ */
    #waveform {
      width: 100%;
      height: 120px;
      background-color: white;
      border-radius: 5px;
      border: 1px solid #ddd;
      margin-bottom: 15px;
    }

    .waveform-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .time-display {
      font-family: monospace;
      font-size: 14px;
      color: #666;
      margin: 0 10px;
    }

    .volume-control {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .volume-control input {
      width: 80px;
    }

    /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
    .alert {
      padding: 12px 16px;
      margin-bottom: 20px;
      border-radius: 5px;
      position: relative;
    }

    .alert-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-warning {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .alert-danger {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* ë±ƒì§€ ìŠ¤íƒ€ì¼ */
    .badge {
      display: inline-block;
      padding: 0.35em 0.65em;
      font-size: 0.75em;
      font-weight: 700;
      line-height: 1;
      text-align: center;
      white-space: nowrap;
      vertical-align: baseline;
      border-radius: 0.375rem;
    }

    .bg-success { background-color: #28a745 !important; color: white; }
    .bg-warning { background-color: #ffc107 !important; color: #333; }
    .bg-danger { background-color: #dc3545 !important; color: white; }
    .bg-secondary { background-color: #6c757d !important; color: white; }

    /* ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ */
    .spinner-border {
      width: 1rem;
      height: 1rem;
      border: 0.125em solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      animation: spinner-border 0.75s linear infinite;
    }

    @keyframes spinner-border {
      to { transform: rotate(360deg); }
    }

    /* Alignment ì‹œê°í™” ìŠ¤íƒ€ì¼ */
    #alignmentTimeline {
      height: 60px;
      background-color: #f8f9fa;
      border-radius: 3px;
      margin-bottom: 15px;
      position: relative;
      overflow: hidden;
      border: 1px solid #ddd;
    }

    #alignmentText {
      background-color: #f8f9fa;
      padding: 10px;
      border-radius: 3px;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.8;
      border: 1px solid #ddd;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    /* íƒ­ ìŠ¤íƒ€ì¼ */
    .tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e9ecef;
    }

    .tab-button {
      padding: 10px 20px;
      background-color: transparent;
      border: none;
      cursor: pointer;
      border-radius: 5px 5px 0 0;
      font-size: 14px;
      color: #666;
      transition: all 0.3s ease;
    }

    .tab-button.active {
      background-color: #007bff;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ë©”íƒ€ë°ì´í„° ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .metadata-section {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }

    .metadata-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }

    .metadata-item {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #007bff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* ì¹´í…Œê³ ë¦¬ ë°ì´í„° ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .category-data-section {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }

    .category-data-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }

    .category-data-item {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #28a745;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* React Native ë©”íƒ€ë°ì´í„° ìŠ¤íƒ€ì¼ */
    .metadata-section-box {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #17a2b8;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .metadata-section-box h4 {
      margin: 0 0 15px 0;
      color: #17a2b8;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .metadata-section-box div {
      margin: 8px 0;
      padding: 5px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .metadata-section-box div:last-child {
      border-bottom: none;
    }

    .metadata-section-box strong {
      color: #333;
      display: inline-block;
      width: 120px;
    }

    .loading-spinner {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 20px;
    }

    .error {
      color: #dc3545;
      background-color: #f8d7da;
      padding: 15px;
      border-radius: 5px;
      border-left: 4px solid #dc3545;
    }

    .no-data {
      color: #6c757d;
      text-align: center;
      padding: 20px;
      font-style: italic;
    }

    /* ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="{% url 'audio_list' %}" class="back-button">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    
    <h1>ğŸµ ì˜¤ë””ì˜¤ íŒŒì¼ ìƒì„¸ ì •ë³´</h1>

    <!-- ë©”ì‹œì§€ í‘œì‹œ -->
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    <!-- WaveSurfer.js ì‹œê°í™” -->
    <div class="section">
      <h3>ğŸµ ì˜¤ë””ì˜¤ íŒŒí˜• ì‹œê°í™”</h3>
      <div id="waveform"></div>
      <div class="waveform-controls">
        <button id="playPauseBtn" class="btn btn-success">â–¶ï¸ ì¬ìƒ</button>
        <button id="stopBtn" class="btn btn-danger">â¹ï¸ ì •ì§€</button>
        <div class="time-display">
          <span id="currentTime">00:00</span> / <span id="totalTime">00:00</span>
        </div>
        <div class="volume-control">
          <label for="volumeSlider">ë³¼ë¥¨:</label>
          <input type="range" id="volumeSlider" min="0" max="100" value="50">
        </div>
      </div>
    </div>

    <!-- ê¸°ë³¸ ì˜¤ë””ì˜¤ íŒŒì¼ ì„¹ì…˜ -->
    <div class="section">
      <h3>ğŸ§ ì˜¤ë””ì˜¤ íŒŒì¼ (ê¸°ë³¸ ì»¨íŠ¸ë¡¤)</h3>
      <audio controls src="{{ audio.audio_file.url }}" style="width: 100%;"></audio>
      
      <div style="margin-top: 15px;">
        <a href="{{ audio.audio_file.url }}" download class="btn btn-primary">ğŸ’¾ ë‹¤ìš´ë¡œë“œ</a>
        
        <!-- Whisper ì „ì‚¬ ë²„íŠ¼ê³¼ ìƒíƒœ í‘œì‹œ -->
        {% if audio.status == 'processing' %}
          <button class="btn btn-warning" disabled>
            <span class="spinner-border spinner-border-sm" role="status"></span>
            ğŸ§  ì „ì‚¬ ì§„í–‰ ì¤‘...
          </button>
        {% else %}
          <form method="POST" action="{% url 'transcribe_single_audio' audio.id %}" style="display: inline;" id="transcribeForm">
            {% csrf_token %}
            <button type="submit" class="btn btn-success" id="transcribeBtn">ğŸ§  Whisper ì „ì‚¬</button>
          </form>
        {% endif %}
        
        <!-- ì „ì‚¬ ìƒíƒœ í‘œì‹œ -->
        {% if audio.status == 'completed' %}
          <span class="badge bg-success">âœ… ì „ì‚¬ ì™„ë£Œ</span>
        {% elif audio.status == 'processing' %}
          <span class="badge bg-warning">â³ ì „ì‚¬ ì§„í–‰ ì¤‘</span>
        {% elif audio.status == 'failed' %}
          <span class="badge bg-danger">âŒ ì „ì‚¬ ì‹¤íŒ¨</span>
        {% else %}
          <span class="badge bg-secondary">â¸ï¸ ì „ì‚¬ ëŒ€ê¸°</span>
        {% endif %}
      </div>
    </div>

    <!-- ê¸°ë³¸ ì •ë³´ -->
    <div class="info-grid">
      <div class="info-item">
        <h3>ğŸ“Š ì¹´í…Œê³ ë¦¬</h3>
        <p>{{ audio.get_category_display }}</p>
      </div>
      
      <div class="info-item">
        <h3>ğŸ“… ì—…ë¡œë“œ ì‹œê°„</h3>
        <p>{{ audio.created_at|date:"Y-m-d H:i" }}</p>
      </div>
      
      <div class="info-item">
        <h3>ğŸš¦ ìƒíƒœ</h3>
        <p>{{ audio.get_status_display }}</p>
      </div>
      
      <div class="info-item">
        <h3>ğŸ†” íŒŒì¼ ID</h3>
        <p>{{ audio.id }}</p>
      </div>

      <div class="info-item">
        <h3>ğŸ“± ë°ì´í„° ì†ŒìŠ¤</h3>
        <p>{{ audio.get_data_source_display|default:"ëª¨ë°”ì¼ ì•±" }}</p>
      </div>

      <div class="info-item">
        <h3>ğŸ”„ ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</h3>
        <p>{{ audio.updated_at|date:"Y-m-d H:i" }}</p>
      </div>
    </div>

    <!-- ê³µí†µ í•„ë“œ ì •ë³´ -->
    <div class="section">
      <h3>ğŸ‘¤ ê³µí†µ ê¸°ë³¸ ì •ë³´</h3>
      <div class="info-grid">
        <div class="info-item">
          <h3>ğŸ‘¤ ì´ë¦„</h3>
          <p>{{ audio.name|default:"<span class='empty-value'>ì…ë ¥ë˜ì§€ ì•ŠìŒ</span>"|safe }}</p>
        </div>
        
        <div class="info-item">
          <h3>âš¥ ì„±ë³„</h3>
          <p>{{ audio.gender|default:"<span class='empty-value'>ì…ë ¥ë˜ì§€ ì•ŠìŒ</span>"|safe }}</p>
        </div>
        
        <div class="info-item">
          <h3>ğŸ‚ ë‚˜ì´</h3>
          <p>{{ audio.age|default:"<span class='empty-value'>ê³„ì‚°ë˜ì§€ ì•ŠìŒ</span>"|safe }}</p>
        </div>
        
        <div class="info-item">
          <h3>ğŸ“… ì¶œìƒì—°ë„</h3>
          <p>{{ audio.birth_year|default:"<span class='empty-value'>ì…ë ¥ë˜ì§€ ì•ŠìŒ</span>"|safe }}</p>
        </div>
        
        <div class="info-item">
          <h3>ğŸ“… ì¶œìƒì›”</h3>
          <p>{{ audio.birth_month|default:"<span class='empty-value'>ì…ë ¥ë˜ì§€ ì•ŠìŒ</span>"|safe }}</p>
        </div>
        
        <div class="info-item">
          <h3>ğŸ“… ì¶œìƒì¼</h3>
          <p>{{ audio.birth_day|default:"<span class='empty-value'>ì…ë ¥ë˜ì§€ ì•ŠìŒ</span>"|safe }}</p>
        </div>
      </div>
    </div>

    <!-- ë…¹ìŒ í™˜ê²½ ì •ë³´ -->
    <div class="section">
      <h3>ğŸ¤ ë…¹ìŒ í™˜ê²½ ì •ë³´</h3>
      <div class="info-grid">
        <div class="info-item">
          <h3>ğŸ“ ë…¹ìŒ ì¥ì†Œ</h3>
          <p>{{ audio.recording_location|default:"<span class='empty-value'>ì…ë ¥ë˜ì§€ ì•ŠìŒ</span>"|safe }}</p>
        </div>
        
        <div class="info-item">
          <h3>ğŸ”Š ì†ŒìŒ ìˆ˜ì¤€</h3>
          <p>{{ audio.noise_level|default:"<span class='empty-value'>ì…ë ¥ë˜ì§€ ì•ŠìŒ</span>"|safe }}</p>
        </div>
        
        <div class="info-item">
          <h3>ğŸ“± ë…¹ìŒ ê¸°ê¸°</h3>
          <p>{{ audio.device_type|default:"<span class='empty-value'>ì…ë ¥ë˜ì§€ ì•ŠìŒ</span>"|safe }}</p>
        </div>
        
        <div class="info-item">
          <h3>ğŸ¤ ë§ˆì´í¬ ìœ ë¬´</h3>
          <p>{{ audio.has_microphone|default:"<span class='empty-value'>ì…ë ¥ë˜ì§€ ì•ŠìŒ</span>"|safe }}</p>
        </div>
        
        <div class="info-item">
          <h3>ğŸ¥ ì§„ë‹¨ëª…</h3>
          <p>{{ audio.diagnosis|default:"<span class='empty-value'>ì…ë ¥ë˜ì§€ ì•ŠìŒ</span>"|safe }}</p>
        </div>
      </div>
    </div>

    <!-- React Native ë©”íƒ€ë°ì´í„° ì •ë³´ -->
    <div class="metadata-section" id="react-native-metadata" style="background-color: #e8f5e8; border-left: 4px solid #28a745;">
      <h3>ğŸ“± React Native ì•± ë©”íƒ€ë°ì´í„°</h3>
      <div id="metadata-display">
        <div class="loading-spinner">
          <div style="text-align: center;">
            <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #28a745; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px;"></div>
            ë©”íƒ€ë°ì´í„° ë¡œë”© ì¤‘...
          </div>
        </div>
      </div>
    </div>

    <!-- ê¸°ë³¸ ë©”íƒ€ë°ì´í„° ì„¹ì…˜ -->
    <div class="metadata-section">
      <h3>ğŸ“‹ ê¸°ë³¸ ì •ë³´</h3>
      <div class="metadata-grid">
        {% for field_name, field_value in metadata_fields.items %}
            {% if field_value %}
                <div class="metadata-item">
                    <strong>{{ field_name|title }}:</strong> {{ field_value }}
                </div>
            {% endif %}
        {% endfor %}
      </div>
    </div>

    <!-- ì¹´í…Œê³ ë¦¬ë³„ ë°ì´í„° ì„¹ì…˜ -->
    {% if has_category_data %}
    <div class="category-data-section">
      <h3>ğŸ·ï¸ {{ category_name }} ì „ìš© ì •ë³´</h3>
      <div class="category-data-grid">
        {% for field_key, field_value in category_data_display.items %}
            {% if field_value %}
                <div class="category-data-item">
                    <strong>{{ field_key }}:</strong> {{ field_value }}
                </div>
            {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- ì¹´í…Œê³ ë¦¬ë³„ íŠ¹í™” ì •ë³´ -->
    {% if audio.category_specific_data %}
    <div class="category-info-section">
      <div class="category-info-header">
        <h3>ğŸ·ï¸ {{ audio.get_category_display }} íŠ¹í™” ì •ë³´</h3>
        <span class="category-badge category-{{ audio.category }}">{{ audio.get_category_display }}</span>
      </div>
      
      {% if audio.category == 'child' %}
        <div class="category-fields-grid">
          <div class="category-field-item">
            <div class="label">ğŸ“ ì¥ì†Œ</div>
            <div class="value">{{ audio.category_specific_data.place|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
          <div class="category-field-item">
            <div class="label">ğŸŒ ì§€ì—­</div>
            <div class="value">{{ audio.category_specific_data.region|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
          <div class="category-field-item">
            <div class="label">ğŸ—£ï¸ ë°œìŒ ë¬¸ì œ</div>
            <div class="value">{{ audio.category_specific_data.pronunciation_problem|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
          <div class="category-field-item">
            <div class="label">â­ ì£¼ê´€ì  í‰ê°€</div>
            <div class="value">{{ audio.category_specific_data.subjective_rating|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
          <div class="category-field-item">
            <div class="label">ğŸ“ ë¬¸ì¥ ë²ˆí˜¸</div>
            <div class="value">{{ audio.category_specific_data.sentence_index|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
          <div class="category-field-item">
            <div class="label">ğŸ’¬ ë¬¸ì¥ ë‚´ìš©</div>
            <div class="value">{{ audio.category_specific_data.sentence_text|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
          <div class="category-field-item">
            <div class="label">ğŸ“‹ ê³¼ì œ ìœ í˜•</div>
            <div class="value">{{ audio.category_specific_data.task_type|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
          <div class="category-field-item">
            <div class="label">ğŸ“… ë…¹ìŒ ë‚ ì§œ</div>
            <div class="value">{{ audio.category_specific_data.recording_date|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
          <div class="category-field-item">
            <div class="label">â° ì—…ë¡œë“œ ì‹œê°„</div>
            <div class="value">{{ audio.category_specific_data.upload_timestamp|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
          <div class="category-field-item">
            <div class="label">ğŸ’¾ ë¡œì»¬ ì €ì¥</div>
            <div class="value">{{ audio.category_specific_data.local_saved|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
        </div>
      {% elif audio.category == 'senior' %}
        <div class="category-fields-grid">
          <div class="category-field-item">
            <div class="label">ğŸ“ êµìœ¡ ìˆ˜ì¤€</div>
            <div class="value">{{ audio.category_specific_data.education|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
          <div class="category-field-item">
            <div class="label">ğŸ—£ï¸ ëª©ì†Œë¦¬ ë¬¸ì œ</div>
            <div class="value">{{ audio.category_specific_data.has_voice_problem|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
        </div>
      {% elif audio.category == 'auditory' %}
        <div class="category-fields-grid">
          <div class="category-field-item">
            <div class="label">ğŸ“ êµìœ¡ ìˆ˜ì¤€</div>
            <div class="value">{{ audio.category_specific_data.education|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
          <div class="category-field-item">
            <div class="label">ğŸ‘‚ ì²­ë ¥ ìˆ˜ì¤€</div>
            <div class="value">{{ audio.category_specific_data.hearing_level|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
          <div class="category-field-item">
            <div class="label">â° ë‚œì²­ ì§€ì† ê¸°ê°„</div>
            <div class="value">{{ audio.category_specific_data.hearing_loss_duration|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
          <div class="category-field-item">
            <div class="label">ğŸ¦» ë³´ì²­ê¸° ì‚¬ìš©</div>
            <div class="value">{{ audio.category_specific_data.has_hearing_aid|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
          <div class="category-field-item">
            <div class="label">ğŸ§  ì¸ì§€ ìˆ˜ì¤€</div>
            <div class="value">{{ audio.category_specific_data.cognitive_level|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
          <div class="category-field-item">
            <div class="label">ğŸŒ ì§€ì—­</div>
            <div class="value">{{ audio.category_specific_data.region|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
          <div class="category-field-item">
            <div class="label">ğŸ—£ï¸ ëª©ì†Œë¦¬ ë¬¸ì œ</div>
            <div class="value">{{ audio.category_specific_data.has_voice_problem|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
        </div>
      {% elif audio.category == 'atypical' %}
        <div class="category-fields-grid">
          <div class="category-field-item">
            <div class="label">ğŸ¥ ì¥ì•  ìœ í˜•</div>
            <div class="value">{{ audio.category_specific_data.disorder_type|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
          <div class="category-field-item">
            <div class="label">ğŸ“Š ì¤‘ì¦ë„</div>
            <div class="value">{{ audio.category_specific_data.severity_level|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
          <div class="category-field-item">
            <div class="label">ğŸ¥ ì¹˜ë£Œ ì´ë ¥</div>
            <div class="value">{{ audio.category_specific_data.therapy_history|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
          <div class="category-field-item">
            <div class="label">ğŸ¥ ì˜í•™ì  ì§„ë‹¨</div>
            <div class="value">{{ audio.category_specific_data.medical_diagnosis|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
        </div>
      {% elif audio.category == 'normal' %}
        <div class="category-fields-grid">
          <div class="category-field-item">
            <div class="label">ğŸ“ êµìœ¡ ìˆ˜ì¤€</div>
            <div class="value">{{ audio.category_specific_data.education_level|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
          <div class="category-field-item">
            <div class="label">ğŸ’¼ ì§ì—…</div>
            <div class="value">{{ audio.category_specific_data.occupation|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
          <div class="category-field-item">
            <div class="label">ğŸ—ºï¸ ë°©ì–¸ ì§€ì—­</div>
            <div class="value">{{ audio.category_specific_data.dialect_region|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
          <div class="category-field-item">
            <div class="label">ğŸ  ë…¹ìŒ í™˜ê²½</div>
            <div class="value">{{ audio.category_specific_data.recording_environment|default:"ì…ë ¥ë˜ì§€ ì•ŠìŒ" }}</div>
          </div>
        </div>
      {% endif %}
    </div>
    {% else %}
    <div class="section">
      <h3>ğŸ·ï¸ {{ audio.get_category_display }} íŠ¹í™” ì •ë³´</h3>
      <p style="color: #666; font-style: italic; text-align: center; padding: 20px;">
        ì´ ì¹´í…Œê³ ë¦¬ì— ëŒ€í•œ íŠ¹í™” ì •ë³´ê°€ ì•„ì§ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
      </p>
    </div>
    {% endif %}

    <!-- SNR ë¶„ì„ ì •ë³´ -->
    <div class="section">
      <h3>ğŸ“Š SNR (Signal-to-Noise Ratio) ë¶„ì„</h3>
      <div class="info-grid">
        <div class="info-item">
          <h3>ğŸ“ˆ í‰ê·  SNR</h3>
          <p>{{ audio.snr_mean|default:"<span class='empty-value'>ë¶„ì„ë˜ì§€ ì•ŠìŒ</span>"|safe }}</p>
        </div>
        
        <div class="info-item">
          <h3>ğŸ” ìµœëŒ€ SNR</h3>
          <p>{{ audio.snr_max|default:"<span class='empty-value'>ë¶„ì„ë˜ì§€ ì•ŠìŒ</span>"|safe }}</p>
        </div>
        
        <div class="info-item">
          <h3>ğŸ”» ìµœì†Œ SNR</h3>
          <p>{{ audio.snr_min|default:"<span class='empty-value'>ë¶„ì„ë˜ì§€ ì•ŠìŒ</span>"|safe }}</p>
        </div>
      </div>
    </div>

    <!-- ì „ì‚¬ ë‚´ìš© (ì½ê¸° ì „ìš©) -->
    <div class="section">
      <h3>ğŸ“ ìë™ ì „ì‚¬ ë‚´ìš©</h3>
      <div style="background-color: white; border: 1px solid #ddd; border-radius: 5px; min-height: 100px; padding: 15px;">
        {% if audio.transcription %}
          <div style="font-size: 14px; line-height: 1.6; color: #333; white-space: pre-wrap; word-wrap: break-word;">
            {{ audio.transcription }}
          </div>
        {% else %}
          <div style="display: flex; align-items: center; justify-content: center; min-height: 80px; font-style: italic; color: #666;">
            ì•„ì§ ì „ì‚¬ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. Whisper ì „ì‚¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìë™ ì „ì‚¬ë¥¼ ì‹œì‘í•˜ê±°ë‚˜ ì•„ë˜ì—ì„œ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.
          </div>
        {% endif %}
      </div>
    </div>

    <!-- WhisperX Forced Alignment ì„¹ì…˜ -->
    <div class="section">
      <h3>ğŸ¯ WhisperX Forced Alignment</h3>
      <div style="margin-bottom: 15px;">
        <p>WhisperXë¥¼ ì‚¬ìš©í•˜ì—¬ ì „ì‚¬ì™€ í•¨ê»˜ ë‹¨ì–´/ë¬¸ì¥ ë‹¨ìœ„ì˜ ì •í™•í•œ ì‹œê°„ ì •ë³´(forced alignment)ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        
        <!-- Alignment ìƒíƒœ í‘œì‹œ -->
        <div style="margin: 10px 0;">
          {% if audio.alignment_status == 'completed' %}
            <span class="badge bg-success">âœ… Alignment ì™„ë£Œ</span>
          {% elif audio.alignment_status == 'processing' %}
            <span class="badge bg-warning">â³ Alignment ì§„í–‰ ì¤‘</span>
          {% elif audio.alignment_status == 'failed' %}
            <span class="badge bg-danger">âŒ Alignment ì‹¤íŒ¨</span>
          {% else %}
            <span class="badge bg-secondary">â¸ï¸ Alignment ëŒ€ê¸°</span>
          {% endif %}
        </div>
        
        <!-- Alignment ì‹¤í–‰ ë²„íŠ¼ -->
        <div>
          {% if audio.alignment_status == 'processing' %}
            <button class="btn btn-warning" disabled>
              <span class="spinner-border spinner-border-sm" role="status"></span>
              ğŸ¯ Alignment ì§„í–‰ ì¤‘...
            </button>
          {% else %}
            <form method="POST" action="{% url 'whisperx_align_audio' audio.id %}" style="display: inline;" id="alignmentForm">
              {% csrf_token %}
              <button type="submit" class="btn btn-primary" id="alignmentBtn">ğŸ¯ WhisperX Alignment ì‹œì‘</button>
            </form>
          {% endif %}
          
          {% if audio.alignment_data and audio.alignment_status == 'completed' %}
            <button class="btn btn-success" onclick="showAlignmentVisualization()">ğŸ‘ï¸ Alignment ê²°ê³¼ ë³´ê¸°</button>
          {% endif %}
        </div>
      </div>
      
      <!-- Alignment ì‹œê°í™” ì˜ì—­ -->
      <div id="alignmentVisualization" style="display: none; margin-top: 20px;">
        <h4>ğŸµ Alignment ì‹œê°í™”</h4>
        <div style="background-color: white; border: 1px solid #ddd; border-radius: 5px; padding: 15px;">
          <div id="alignmentTimeline"></div>
          <div style="margin-bottom: 15px;">
            <button class="btn btn-primary" onclick="playAlignmentSegment()">â–¶ï¸ ì¬ìƒ</button>
            <button class="btn btn-secondary" onclick="pauseAlignment()">â¸ï¸ ì¼ì‹œì •ì§€</button>
            <select id="alignmentModeSelect" onchange="changeAlignmentMode()" style="margin-left: 10px; padding: 5px;">
              <option value="segments">ë¬¸ì¥ ë‹¨ìœ„</option>
              <option value="words">ë‹¨ì–´ ë‹¨ìœ„</option>
            </select>
          </div>
          <div id="alignmentText"></div>
        </div>
      </div>
    </div>

    <!-- í¸ì§‘ ì„¹ì…˜ë“¤ì„ íƒ­ìœ¼ë¡œ êµ¬ì„± -->
    <div class="section">
      <h3>âœï¸ í¸ì§‘ ë° ìˆ˜ì •</h3>
      
      <div class="tabs">
        <button class="tab-button active" onclick="switchTab('transcription-tab')">ğŸ“ ì „ì‚¬ ìˆ˜ì •</button>
        <button class="tab-button" onclick="switchTab('metadata-tab')">ğŸ“Š ë©”íƒ€ë°ì´í„° ìˆ˜ì •</button>
        <button class="tab-button" onclick="switchTab('category-tab')">ğŸ·ï¸ ì¹´í…Œê³ ë¦¬ ì •ë³´ ìˆ˜ì •</button>
      </div>

      <!-- ì „ì‚¬ ìˆ˜ì • íƒ­ -->
      <div id="transcription-tab" class="tab-content active">
        <form method="POST" action="{% url 'update_transcription' audio.id %}">
          {% csrf_token %}
          <div class="form-group">
            <label for="transcription">ì „ì‚¬ ë‚´ìš©</label>
            <textarea name="transcription" id="transcription" placeholder="ì „ì‚¬ ë‚´ìš©ì„ ìˆ˜ì •í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”..." style="min-height: 120px;">{{ audio.transcription|default_if_none:"" }}</textarea>
          </div>
          <button type="submit" class="btn btn-success">ğŸ’¾ ì „ì‚¬ ë‚´ìš© ì €ì¥</button>
        </form>
      </div>

      <!-- ë©”íƒ€ë°ì´í„° ìˆ˜ì • íƒ­ -->
      <div id="metadata-tab" class="tab-content">
        <form method="POST" action="{% url 'update_audio_metadata' audio.id %}">
          {% csrf_token %}
          <div class="form-row">
            <div class="form-group">
              <label for="name">ì´ë¦„</label>
              <input type="text" name="name" id="name" value="{{ audio.name|default_if_none:"" }}" placeholder="ì´ë¦„ ì…ë ¥">
            </div>
            
            <div class="form-group">
              <label for="gender">ì„±ë³„</label>
              <select name="gender" id="gender">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="male" {% if audio.gender == 'male' %}selected{% endif %}>ë‚¨ì„±</option>
                <option value="female" {% if audio.gender == 'female' %}selected{% endif %}>ì—¬ì„±</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="birth_year">ì¶œìƒì—°ë„</label>
              <input type="text" name="birth_year" id="birth_year" value="{{ audio.birth_year|default_if_none:"" }}" placeholder="ì˜ˆ: 1990">
            </div>
            
            <div class="form-group">
              <label for="birth_month">ì¶œìƒì›”</label>
              <input type="text" name="birth_month" id="birth_month" value="{{ audio.birth_month|default_if_none:"" }}" placeholder="ì˜ˆ: 01">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="birth_day">ì¶œìƒì¼</label>
              <input type="text" name="birth_day" id="birth_day" value="{{ audio.birth_day|default_if_none:"" }}" placeholder="ì˜ˆ: 15">
            </div>
            
            <div class="form-group">
              <label for="category">ì¹´í…Œê³ ë¦¬</label>
              <select name="category" id="category">
                <option value="child" {% if audio.category == 'child' %}selected{% endif %}>ì•„ë™ ë§ê³¼ì œ</option>
                <option value="senior" {% if audio.category == 'senior' %}selected{% endif %}>ì¥ë…¸ë…„ ë§ê³¼ì œ</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="recording_location">ë…¹ìŒ ì¥ì†Œ</label>
              <input type="text" name="recording_location" id="recording_location" value="{{ audio.recording_location|default_if_none:"" }}" placeholder="ë…¹ìŒ ì¥ì†Œ">
            </div>
            
            <div class="form-group">
              <label for="noise_level">ì†ŒìŒ ìˆ˜ì¤€</label>
              <input type="text" name="noise_level" id="noise_level" value="{{ audio.noise_level|default_if_none:"" }}" placeholder="ì†ŒìŒ ìˆ˜ì¤€">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="device_type">ë…¹ìŒ ê¸°ê¸°</label>
              <input type="text" name="device_type" id="device_type" value="{{ audio.device_type|default_if_none:"" }}" placeholder="ë…¹ìŒ ê¸°ê¸°">
            </div>
            
            <div class="form-group">
              <label for="has_microphone">ë§ˆì´í¬ ìœ ë¬´</label>
              <input type="text" name="has_microphone" id="has_microphone" value="{{ audio.has_microphone|default_if_none:"" }}" placeholder="ë§ˆì´í¬ ìœ ë¬´">
            </div>
          </div>
          
          <div class="form-group">
            <label for="diagnosis">ì§„ë‹¨ëª…</label>
            <input type="text" name="diagnosis" id="diagnosis" value="{{ audio.diagnosis|default_if_none:"" }}" placeholder="ì§„ë‹¨ëª…">
          </div>
          
          <button type="submit" class="btn btn-warning">ğŸ“ ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸</button>
        </form>
      </div>

      <!-- ì¹´í…Œê³ ë¦¬ ì •ë³´ ìˆ˜ì • íƒ­ -->
      <div id="category-tab" class="tab-content">
        <form method="POST" action="{% url 'update_category_data' audio.id %}">
          {% csrf_token %}
          <div id="category-specific-fields">
            <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
          </div>
          <button type="submit" class="btn btn-primary">ğŸ·ï¸ ì¹´í…Œê³ ë¦¬ ì •ë³´ ì—…ë°ì´íŠ¸</button>
        </form>
      </div>
    </div>

    <div style="text-align: center; margin-top: 30px;">
      <a href="{% url 'audio_list' %}" class="btn btn-danger">âŒ ë‹«ê¸°</a>
    </div>
  </div>

  <script>
    // ë·°ì—ì„œ ì „ë‹¬ë°›ì€ JSON ë¬¸ìì—´ íŒŒì‹±
    const categorySpecificData = JSON.parse('{{ category_data_json|escapejs }}');
    const alignmentData = JSON.parse('{{ alignment_data_json|escapejs }}');
    
    console.log('Category Specific Data:', categorySpecificData);
    console.log('Alignment Data:', alignmentData);

    // ìµœì‹  ë¸Œë¼ìš°ì €ìš© UTF-8 ì•ˆì „ Base64 ë””ì½”ë”© í•¨ìˆ˜
    function utf8SafeBase64Decode(str) {
      try {
        // ìµœì‹  ë¸Œë¼ìš°ì €ì—ì„œ ì§€ì›í•˜ëŠ” TextDecoder ì‚¬ìš©
        if (typeof TextDecoder !== 'undefined') {
          const binaryString = atob(str);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          return new TextDecoder('utf-8').decode(bytes);
        } else {
          // êµ¬í˜• ë¸Œë¼ìš°ì € fallback
          const decoded = atob(str);
          return decodeURIComponent(escape(decoded));
        }
      } catch (e) {
        console.error('Base64 decoding error:', e);
        // ìµœí›„ì˜ ìˆ˜ë‹¨: ì›ë³¸ atob ì‚¬ìš©
        return atob(str);
      }
    }

    // React Native ë©”íƒ€ë°ì´í„° íŒŒì‹± ë° í‘œì‹œ
    function displayReactNativeMetadata() {
      const metadataDisplay = document.getElementById('metadata-display');
      
      if (categorySpecificData && categorySpecificData.metadata_json) {
        try {
          // UTF-8 ì•ˆì „ Base64 ë””ì½”ë”©
          const decodedMetadata = utf8SafeBase64Decode(categorySpecificData.metadata_json);
          console.log('Decoded metadata string:', decodedMetadata);
          const metadata = JSON.parse(decodedMetadata);
          
          console.log('Parsed React Native Metadata:', metadata);

          // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
          function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
          }
          
          let metadataHtml = '<div class="metadata-grid">';
          
          // ì•„ë™ ì •ë³´ ì„¹ì…˜
          if (metadata.metainfo_child) {
            const child = metadata.metainfo_child;
            metadataHtml += `
              <div class="metadata-section-box">
                <h4>ğŸ‘¶ ì•„ë™ ì •ë³´</h4>
                ${child.name ? `<div><strong>ì´ë¦„:</strong> ${escapeHtml(child.name)}</div>` : ''}
                ${child.gender ? `<div><strong>ì„±ë³„:</strong> ${escapeHtml(child.gender)}</div>` : ''}
                ${child.age ? `<div><strong>ë‚˜ì´:</strong> ${escapeHtml(child.age)}</div>` : ''}
                ${child.birthDate ? `<div><strong>ìƒë…„ì›”ì¼:</strong> ${escapeHtml(child.birthDate)}</div>` : ''}
                ${child.recordingDate ? `<div><strong>ë…¹ìŒ ë‚ ì§œ:</strong> ${escapeHtml(child.recordingDate)}</div>` : ''}
                ${child.region ? `<div><strong>ì§€ì—­:</strong> ${escapeHtml(child.region)}</div>` : ''}
                ${child.place ? `<div><strong>ì¥ì†Œ:</strong> ${escapeHtml(child.place)}</div>` : ''}
                ${child.noise ? `<div><strong>ì†ŒìŒ ìˆ˜ì¤€:</strong> ${escapeHtml(child.noise)}</div>` : ''}
                ${child.pronunProblem ? `<div><strong>ë°œìŒ ë¬¸ì œ:</strong> ${escapeHtml(child.pronunProblem)}</div>` : ''}
                ${child.diagnosis ? `<div><strong>ì§„ë‹¨:</strong> ${escapeHtml(child.diagnosis)}</div>` : ''}
                ${child.device ? `<div><strong>ê¸°ê¸°:</strong> ${escapeHtml(child.device)}</div>` : ''}
                ${child.mic ? `<div><strong>ë§ˆì´í¬:</strong> ${escapeHtml(child.mic)}</div>` : ''}
              </div>
            `;
          }
          
          // ê³¼ì œ ì •ë³´ ì„¹ì…˜
          if (metadata.task_info) {
            const task = metadata.task_info;
            metadataHtml += `
              <div class="metadata-section-box">
                <h4>ğŸ“ ê³¼ì œ ì •ë³´</h4>
                ${task.task_type ? `<div><strong>ê³¼ì œ ìœ í˜•:</strong> ${escapeHtml(task.task_type)}</div>` : ''}
                ${task.task_description ? `<div><strong>ê³¼ì œ ì„¤ëª…:</strong> ${escapeHtml(task.task_description)}</div>` : ''}
                ${task.sentence_text ? `<div><strong>ë¬¸ì¥:</strong> ${escapeHtml(task.sentence_text)}</div>` : ''}
                ${task.sentence_index !== undefined ? `<div><strong>ë¬¸ì¥ ë²ˆí˜¸:</strong> ${task.sentence_index}</div>` : ''}
                ${task.total_sentences ? `<div><strong>ì „ì²´ ë¬¸ì¥ ìˆ˜:</strong> ${task.total_sentences}</div>` : ''}
                ${task.session_id ? `<div><strong>ì„¸ì…˜ ID:</strong> ${escapeHtml(task.session_id)}</div>` : ''}
                ${task.platform ? `<div><strong>í”Œë«í¼:</strong> ${escapeHtml(task.platform)}</div>` : ''}
              </div>
            `;
          }
          
          // ì—…ë¡œë“œ ì •ë³´ ì„¹ì…˜
          if (metadata.upload_info) {
            const upload = metadata.upload_info;
            metadataHtml += `
              <div class="metadata-section-box">
                <h4>ğŸ“¤ ì—…ë¡œë“œ ì •ë³´</h4>
                ${upload.upload_timestamp ? `<div><strong>ì—…ë¡œë“œ ì‹œê°„:</strong> ${new Date(upload.upload_timestamp).toLocaleString('ko-KR')}</div>` : ''}
                ${upload.recording_timestamp ? `<div><strong>ë…¹ìŒ ì‹œê°„:</strong> ${new Date(upload.recording_timestamp).toLocaleString('ko-KR')}</div>` : ''}
                ${upload.file_format ? `<div><strong>íŒŒì¼ í˜•ì‹:</strong> ${escapeHtml(upload.file_format)}</div>` : ''}
                ${upload.audio_filename ? `<div><strong>íŒŒì¼ëª…:</strong> ${escapeHtml(upload.audio_filename)}</div>` : ''}
                ${upload.subjective_rating ? `<div><strong>ì£¼ê´€ì  í‰ê°€:</strong> ${escapeHtml(upload.subjective_rating)}</div>` : ''}
              </div>
            `;
          }
          
          metadataHtml += '</div>';
          metadataDisplay.innerHTML = metadataHtml;
          
        } catch (error) {
          console.error('ë©”íƒ€ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', error);
          console.error('ì›ë³¸ Base64 ë°ì´í„°:', categorySpecificData.metadata_json);
          metadataDisplay.innerHTML = `
            <div class="error">
              <h4>âŒ ë©”íƒ€ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜</h4>
              <p>ë©”íƒ€ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
              <p><strong>ì˜¤ë¥˜ ë‚´ìš©:</strong> ${escapeHtml(error.message)}</p>
              <details>
                <summary>ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­</summary>
                <pre>${escapeHtml(error.stack || error.toString())}</pre>
              </details>
            </div>
          `;
        }
      } else {
        console.log('React Native ë©”íƒ€ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        metadataDisplay.innerHTML = `
          <div class="no-data">
            <h4>ğŸ“± React Native ë©”íƒ€ë°ì´í„°</h4>
            <p>ì´ ì˜¤ë””ì˜¤ íŒŒì¼ì—ëŠ” React Native ì•±ì—ì„œ ì „ì†¡í•œ ë©”íƒ€ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <p>ìˆ˜ë™ìœ¼ë¡œ ì—…ë¡œë“œëœ íŒŒì¼ì´ê±°ë‚˜ êµ¬ë²„ì „ ì•±ì—ì„œ ì—…ë¡œë“œëœ íŒŒì¼ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
          </div>
        `;
      }
    }

    // ì „ì—­ ë³€ìˆ˜
    let wavesurfer = null;
    let currentAlignmentMode = 'segments';
    let currentSegmentIndex = 0;

    // ì‹œê°„ í¬ë§· í•¨ìˆ˜
    function formatTime(seconds) {
      if (isNaN(seconds) || seconds < 0) return '00:00';
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = Math.floor(seconds % 60);
      return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    // íƒ­ ì „í™˜ í•¨ìˆ˜
    function switchTab(tabId) {
      // ëª¨ë“  íƒ­ ìˆ¨ê¸°ê¸°
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // ì„ íƒëœ íƒ­ í‘œì‹œ
      document.getElementById(tabId).classList.add('active');
      
      // ì„ íƒëœ íƒ­ ë²„íŠ¼ í™œì„±í™”
      event.target.classList.add('active');
      
      // ì¹´í…Œê³ ë¦¬ íƒ­ì´ ì„ íƒë˜ë©´ ì¹´í…Œê³ ë¦¬ë³„ í•„ë“œ ë¡œë“œ
      if (tabId === 'category-tab') {
        loadCategorySpecificFields();
      }
    }
  
    // ì¹´í…Œê³ ë¦¬ë³„ íŠ¹í™” í•„ë“œ ë¡œë“œ
    function loadCategorySpecificFields() {
      const category = '{{ audio.category }}';
      const categoryData = categorySpecificData;
      const container = document.getElementById('category-specific-fields');
      
      let fieldsHtml = '';
      
      if (category === 'child') {
        fieldsHtml = `
          <div class="form-row">
            <div class="form-group">
              <label for="place">ì¥ì†Œ</label>
              <select name="place" id="place">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="ê°€ì •" ${categoryData.place === 'ê°€ì •' ? 'selected' : ''}>ê°€ì •</option>
                <option value="ë³‘ì›" ${categoryData.place === 'ë³‘ì›' ? 'selected' : ''}>ë³‘ì›</option>
                <option value="ì„¼í„°" ${categoryData.place === 'ì„¼í„°' ? 'selected' : ''}>ì„¼í„°</option>
                <option value="ì–´ë¦°ì´ì§‘" ${categoryData.place === 'ì–´ë¦°ì´ì§‘' ? 'selected' : ''}>ì–´ë¦°ì´ì§‘</option>
                <option value="ê¸°íƒ€" ${categoryData.place === 'ê¸°íƒ€' ? 'selected' : ''}>ê¸°íƒ€</option>
              </select>
            </div>
            <div class="form-group">
              <label for="pronun_problem">ë°œìŒ ë¬¸ì œ</label>
              <select name="pronun_problem" id="pronun_problem">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="ì—†ìŒ" ${categoryData.pronun_problem === 'ì—†ìŒ' ? 'selected' : ''}>ì—†ìŒ</option>
                <option value="ìˆìŒ" ${categoryData.pronun_problem === 'ìˆìŒ' ? 'selected' : ''}>ìˆìŒ</option>
              </select>
            </div>
          </div>
        `;
      } else if (category === 'senior') {
        fieldsHtml = `
          <div class="form-row">
            <div class="form-group">
              <label for="education">êµìœ¡ ìˆ˜ì¤€</label>
              <select name="education" id="education">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="ì´ˆë“±í•™êµ" ${categoryData.education === 'ì´ˆë“±í•™êµ' ? 'selected' : ''}>ì´ˆë“±í•™êµ</option>
                <option value="ì¤‘í•™êµ" ${categoryData.education === 'ì¤‘í•™êµ' ? 'selected' : ''}>ì¤‘í•™êµ</option>
                <option value="ê³ ë“±í•™êµ" ${categoryData.education === 'ê³ ë“±í•™êµ' ? 'selected' : ''}>ê³ ë“±í•™êµ</option>
                <option value="ëŒ€í•™êµ" ${categoryData.education === 'ëŒ€í•™êµ' ? 'selected' : ''}>ëŒ€í•™êµ</option>
                <option value="ëŒ€í•™ì›" ${categoryData.education === 'ëŒ€í•™ì›' ? 'selected' : ''}>ëŒ€í•™ì›</option>
              </select>
            </div>
            <div class="form-group">
              <label for="has_voice_problem">ëª©ì†Œë¦¬ ë¬¸ì œ</label>
              <select name="has_voice_problem" id="has_voice_problem">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="ì—†ìŒ" ${categoryData.has_voice_problem === 'ì—†ìŒ' ? 'selected' : ''}>ì—†ìŒ</option>
                <option value="ìˆìŒ" ${categoryData.has_voice_problem === 'ìˆìŒ' ? 'selected' : ''}>ìˆìŒ</option>
              </select>
            </div>
          </div>
        `;
      } else if (category === 'auditory') {
        fieldsHtml = `
          <div class="form-row">
            <div class="form-group">
              <label for="education">êµìœ¡ ìˆ˜ì¤€</label>
              <select name="education" id="education">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="ì´ˆë“±í•™êµ" ${categoryData.education === 'ì´ˆë“±í•™êµ' ? 'selected' : ''}>ì´ˆë“±í•™êµ</option>
                <option value="ì¤‘í•™êµ" ${categoryData.education === 'ì¤‘í•™êµ' ? 'selected' : ''}>ì¤‘í•™êµ</option>
                <option value="ê³ ë“±í•™êµ" ${categoryData.education === 'ê³ ë“±í•™êµ' ? 'selected' : ''}>ê³ ë“±í•™êµ</option>
                <option value="ëŒ€í•™êµ" ${categoryData.education === 'ëŒ€í•™êµ' ? 'selected' : ''}>ëŒ€í•™êµ</option>
                <option value="ëŒ€í•™ì›" ${categoryData.education === 'ëŒ€í•™ì›' ? 'selected' : ''}>ëŒ€í•™ì›</option>
              </select>
            </div>
            <div class="form-group">
              <label for="hearing_level">ì²­ë ¥ ìˆ˜ì¤€</label>
              <select name="hearing_level" id="hearing_level">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="ì •ìƒ" ${categoryData.hearing_level === 'ì •ìƒ' ? 'selected' : ''}>ì •ìƒ</option>
                <option value="ê²½ë„ë‚œì²­" ${categoryData.hearing_level === 'ê²½ë„ë‚œì²­' ? 'selected' : ''}>ê²½ë„ë‚œì²­</option>
                <option value="ì¤‘ë„ë‚œì²­" ${categoryData.hearing_level === 'ì¤‘ë„ë‚œì²­' ? 'selected' : ''}>ì¤‘ë„ë‚œì²­</option>
                <option value="ì¤‘ê³ ë„ë‚œì²­" ${categoryData.hearing_level === 'ì¤‘ê³ ë„ë‚œì²­' ? 'selected' : ''}>ì¤‘ê³ ë„ë‚œì²­</option>
                <option value="ê³ ë„ë‚œì²­" ${categoryData.hearing_level === 'ê³ ë„ë‚œì²­' ? 'selected' : ''}>ê³ ë„ë‚œì²­</option>
                <option value="ì‹¬ë„ë‚œì²­" ${categoryData.hearing_level === 'ì‹¬ë„ë‚œì²­' ? 'selected' : ''}>ì‹¬ë„ë‚œì²­</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="hearing_loss_duration">ë‚œì²­ ì§€ì† ê¸°ê°„</label>
              <select name="hearing_loss_duration" id="hearing_loss_duration">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="ì„ ì²œì„±" ${categoryData.hearing_loss_duration === 'ì„ ì²œì„±' ? 'selected' : ''}>ì„ ì²œì„±</option>
                <option value="1ë…„ ë¯¸ë§Œ" ${categoryData.hearing_loss_duration === '1ë…„ ë¯¸ë§Œ' ? 'selected' : ''}>1ë…„ ë¯¸ë§Œ</option>
                <option value="1-5ë…„" ${categoryData.hearing_loss_duration === '1-5ë…„' ? 'selected' : ''}>1-5ë…„</option>
                <option value="5-10ë…„" ${categoryData.hearing_loss_duration === '5-10ë…„' ? 'selected' : ''}>5-10ë…„</option>
                <option value="10ë…„ ì´ìƒ" ${categoryData.hearing_loss_duration === '10ë…„ ì´ìƒ' ? 'selected' : ''}>10ë…„ ì´ìƒ</option>
              </select>
            </div>
            <div class="form-group">
              <label for="has_hearing_aid">ë³´ì²­ê¸° ì‚¬ìš©</label>
              <select name="has_hearing_aid" id="has_hearing_aid">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="ì—†ìŒ" ${categoryData.has_hearing_aid === 'ì—†ìŒ' ? 'selected' : ''}>ì—†ìŒ</option>
                <option value="ìˆìŒ" ${categoryData.has_hearing_aid === 'ìˆìŒ' ? 'selected' : ''}>ìˆìŒ</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="cognitive_level">ì¸ì§€ ìˆ˜ì¤€</label>
              <select name="cognitive_level" id="cognitive_level">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="ì •ìƒ" ${categoryData.cognitive_level === 'ì •ìƒ' ? 'selected' : ''}>ì •ìƒ</option>
                <option value="ê²½ë„ì¸ì§€ì¥ì• " ${categoryData.cognitive_level === 'ê²½ë„ì¸ì§€ì¥ì• ' ? 'selected' : ''}>ê²½ë„ì¸ì§€ì¥ì• </option>
                <option value="ì¤‘ë“±ë„ì¸ì§€ì¥ì• " ${categoryData.cognitive_level === 'ì¤‘ë“±ë„ì¸ì§€ì¥ì• ' ? 'selected' : ''}>ì¤‘ë“±ë„ì¸ì§€ì¥ì• </option>
                <option value="ì¤‘ë„ì¸ì§€ì¥ì• " ${categoryData.cognitive_level === 'ì¤‘ë„ì¸ì§€ì¥ì• ' ? 'selected' : ''}>ì¤‘ë„ì¸ì§€ì¥ì• </option>
              </select>
            </div>
            <div class="form-group">
              <label for="region">ì§€ì—­</label>
              <select name="region" id="region">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="ì„œìš¸" ${categoryData.region === 'ì„œìš¸' ? 'selected' : ''}>ì„œìš¸</option>
                <option value="ê²½ê¸°" ${categoryData.region === 'ê²½ê¸°' ? 'selected' : ''}>ê²½ê¸°</option>
                <option value="ì¸ì²œ" ${categoryData.region === 'ì¸ì²œ' ? 'selected' : ''}>ì¸ì²œ</option>
                <option value="ê°•ì›" ${categoryData.region === 'ê°•ì›' ? 'selected' : ''}>ê°•ì›</option>
                <option value="ì¶©ë¶" ${categoryData.region === 'ì¶©ë¶' ? 'selected' : ''}>ì¶©ë¶</option>
                <option value="ì¶©ë‚¨" ${categoryData.region === 'ì¶©ë‚¨' ? 'selected' : ''}>ì¶©ë‚¨</option>
                <option value="ëŒ€ì „" ${categoryData.region === 'ëŒ€ì „' ? 'selected' : ''}>ëŒ€ì „</option>
                <option value="ì „ë¶" ${categoryData.region === 'ì „ë¶' ? 'selected' : ''}>ì „ë¶</option>
                <option value="ì „ë‚¨" ${categoryData.region === 'ì „ë‚¨' ? 'selected' : ''}>ì „ë‚¨</option>
                <option value="ê´‘ì£¼" ${categoryData.region === 'ê´‘ì£¼' ? 'selected' : ''}>ê´‘ì£¼</option>
                <option value="ê²½ë¶" ${categoryData.region === 'ê²½ë¶' ? 'selected' : ''}>ê²½ë¶</option>
                <option value="ê²½ë‚¨" ${categoryData.region === 'ê²½ë‚¨' ? 'selected' : ''}>ê²½ë‚¨</option>
                <option value="ëŒ€êµ¬" ${categoryData.region === 'ëŒ€êµ¬' ? 'selected' : ''}>ëŒ€êµ¬</option>
                <option value="ìš¸ì‚°" ${categoryData.region === 'ìš¸ì‚°' ? 'selected' : ''}>ìš¸ì‚°</option>
                <option value="ë¶€ì‚°" ${categoryData.region === 'ë¶€ì‚°' ? 'selected' : ''}>ë¶€ì‚°</option>
                <option value="ì œì£¼" ${categoryData.region === 'ì œì£¼' ? 'selected' : ''}>ì œì£¼</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="has_voice_problem">ëª©ì†Œë¦¬ ë¬¸ì œ</label>
            <select name="has_voice_problem" id="has_voice_problem">
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              <option value="ì—†ìŒ" ${categoryData.has_voice_problem === 'ì—†ìŒ' ? 'selected' : ''}>ì—†ìŒ</option>
              <option value="ìˆìŒ" ${categoryData.has_voice_problem === 'ìˆìŒ' ? 'selected' : ''}>ìˆìŒ</option>
            </select>
          </div>
        `;
      } else {
        fieldsHtml = '<p style="color: #666; font-style: italic;">ì´ ì¹´í…Œê³ ë¦¬ì—ëŠ” íŠ¹í™” í•„ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      }
      
      container.innerHTML = fieldsHtml;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing...');
      
      // React Native ë©”íƒ€ë°ì´í„° í‘œì‹œ
      displayReactNativeMetadata();
      
      // WaveSurfer ì´ˆê¸°í™”
      initWaveSurfer();
      
      // ë©”ì‹œì§€ ìë™ ë‹«ê¸°
      initMessageAutoClose();
      
      // í¼ ì´ë²¤íŠ¸ ì„¤ì •
      initFormEvents();
      
      // Alignment ìƒíƒœ í™•ì¸
      checkAlignmentStatus();
    });

    function initWaveSurfer() {
      try {
        console.log('Initializing WaveSurfer...');
        
        wavesurfer = WaveSurfer.create({
          container: '#waveform',
          waveColor: '#007bff',
          progressColor: '#28a745',
          height: 120,
          barWidth: 2,
          barGap: 1,
          responsive: true,
          normalize: true
        });

        const audioUrl = '{{ audio.audio_file.url }}';
        console.log('Loading audio:', audioUrl);
        wavesurfer.load(audioUrl);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        wavesurfer.on('ready', function() {
          console.log('WaveSurfer ready');
          const totalTime = wavesurfer.getDuration();
          document.getElementById('totalTime').textContent = formatTime(totalTime);
        });

        wavesurfer.on('audioprocess', function() {
          const currentTime = wavesurfer.getCurrentTime();
          document.getElementById('currentTime').textContent = formatTime(currentTime);
        });

        wavesurfer.on('finish', function() {
          document.getElementById('playPauseBtn').textContent = 'â–¶ï¸ ì¬ìƒ';
        });

        wavesurfer.on('error', function(error) {
          console.error('WaveSurfer error:', error);
          document.getElementById('waveform').innerHTML = '<div style="color: red; text-align: center; padding: 20px;">ì˜¤ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨: ' + error + '</div>';
        });

        // ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('playPauseBtn').addEventListener('click', function() {
          try {
            if (wavesurfer.isPlaying()) {
              wavesurfer.pause();
              this.textContent = 'â–¶ï¸ ì¬ìƒ';
            } else {
              wavesurfer.play();
              this.textContent = 'â¸ï¸ ì¼ì‹œì •ì§€';
            }
          } catch (error) {
            console.error('Play/pause error:', error);
          }
        });

        document.getElementById('stopBtn').addEventListener('click', function() {
          try {
            wavesurfer.stop();
            document.getElementById('playPauseBtn').textContent = 'â–¶ï¸ ì¬ìƒ';
          } catch (error) {
            console.error('Stop error:', error);
          }
        });

        document.getElementById('volumeSlider').addEventListener('input', function() {
          try {
            wavesurfer.setVolume(this.value / 100);
          } catch (error) {
            console.error('Volume error:', error);
          }
        });

      } catch (error) {
        console.error('WaveSurfer initialization error:', error);
        document.getElementById('waveform').innerHTML = '<div style="color: red; text-align: center; padding: 20px;">WaveSurfer ì´ˆê¸°í™” ì‹¤íŒ¨</div>';
      }
    }

    function initMessageAutoClose() {
      const alerts = document.querySelectorAll('.alert');
      alerts.forEach(function(alert) {
        setTimeout(function() {
          alert.style.opacity = '0';
          setTimeout(function() {
            alert.remove();
          }, 300);
        }, 5000);
      });
    }

    function initFormEvents() {
      // ì „ì‚¬ í¼
      const transcribeForm = document.getElementById('transcribeForm');
      const transcribeBtn = document.getElementById('transcribeBtn');

      if (transcribeForm && transcribeBtn) {
        transcribeForm.addEventListener('submit', function() {
          transcribeBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ğŸ§  ì „ì‚¬ ì§„í–‰ ì¤‘...';
          transcribeBtn.disabled = true;
          transcribeBtn.className = 'btn btn-warning';
        });
      }

      // Alignment í¼
      const alignmentForm = document.getElementById('alignmentForm');
      const alignmentBtn = document.getElementById('alignmentBtn');

      if (alignmentForm && alignmentBtn) {
        alignmentForm.addEventListener('submit', function() {
          alignmentBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ğŸ¯ Alignment ì§„í–‰ ì¤‘...';
          alignmentBtn.disabled = true;
          alignmentBtn.className = 'btn btn-warning';
        });
      }
    }

    function checkAlignmentStatus() {
      const status = '{{ audio.alignment_status }}';
      if (status === 'processing') {
        const checkInterval = setInterval(function() {
          fetch(`/api/alignment-status/{{ audio.id }}/`)
            .then(response => response.json())
            .then(data => {
              if (data.status !== 'processing') {
                location.reload();
              }
            })
            .catch(error => console.log('Status check error:', error));
        }, 5000);

        window.addEventListener('beforeunload', function() {
          clearInterval(checkInterval);
        });
      }
    }

    // Alignment ì‹œê°í™” í•¨ìˆ˜ë“¤
    function showAlignmentVisualization() {
      console.log('Showing alignment visualization');
      const container = document.getElementById('alignmentVisualization');
      
      if (container.style.display === 'none' || container.style.display === '') {
        container.style.display = 'block';
        loadAlignmentData();
      } else {
        container.style.display = 'none';
      }
    }

    function loadAlignmentData() {
      console.log('Loading alignment data...');
      fetch(`/api/alignment-data/{{ audio.id }}/`)
        .then(response => response.json())
        .then(data => {
          console.log('Alignment data response:', data);
          if (data.success) {
            alignmentData = data.data;
            renderAlignmentVisualization();
          } else {
            document.getElementById('alignmentText').innerHTML = 
              '<div style="color: red;">Alignment ë°ì´í„° ì—†ìŒ: ' + data.error + '</div>';
          }
        })
        .catch(error => {
          console.error('Alignment data load error:', error);
          document.getElementById('alignmentText').innerHTML = 
            '<div style="color: red;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message + '</div>';
        });
    }

    function renderAlignmentVisualization() {
      if (!alignmentData) {
        console.log('No alignment data to render');
        return;
      }

      console.log('Rendering alignment visualization:', alignmentData);

      const timeline = document.getElementById('alignmentTimeline');
      const textContainer = document.getElementById('alignmentText');
      
      timeline.innerHTML = '';
      textContainer.innerHTML = '';

      const data = currentAlignmentMode === 'segments' ? alignmentData.segments : alignmentData.words;
      const totalDuration = alignmentData.duration || 10;

      if (!data || data.length === 0) {
        textContainer.innerHTML = '<div style="color: orange;">Alignment ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>';
        return;
      }

      // íƒ€ì„ë¼ì¸ ì‹œê°í™”
      data.forEach((item, index) => {
        const start = item.start || 0;
        const end = item.end || start + 1;
        const duration = end - start;
        
        const startPercent = (start / totalDuration) * 100;
        const widthPercent = (duration / totalDuration) * 100;
        
        const segment = document.createElement('div');
        segment.style.position = 'absolute';
        segment.style.left = startPercent + '%';
        segment.style.width = widthPercent + '%';
        segment.style.height = '100%';
        segment.style.backgroundColor = index === currentSegmentIndex ? '#28a745' : '#007bff';
        segment.style.border = '1px solid white';
        segment.style.cursor = 'pointer';
        segment.style.opacity = '0.8';
        segment.title = `${item.text || item.word} (${start.toFixed(2)}s - ${end.toFixed(2)}s)`;
        
        segment.addEventListener('click', function() {
          selectSegment(index);
          seekToSegment(start);
        });
        
        timeline.appendChild(segment);
      });

      // í…ìŠ¤íŠ¸ í‘œì‹œ
      renderAlignmentText();
    }

    function renderAlignmentText() {
      if (!alignmentData) return;

      const textContainer = document.getElementById('alignmentText');
      const data = currentAlignmentMode === 'segments' ? alignmentData.segments : alignmentData.words;
      
      textContainer.innerHTML = '';
      
      data.forEach((item, index) => {
        const span = document.createElement('span');
        span.textContent = item.text || item.word;
        span.style.padding = '2px 4px';
        span.style.margin = '2px';
        span.style.borderRadius = '3px';
        span.style.cursor = 'pointer';
        span.style.backgroundColor = index === currentSegmentIndex ? '#28a745' : '#e9ecef';
        span.style.color = index === currentSegmentIndex ? 'white' : 'black';
        
        span.addEventListener('click', function() {
          selectSegment(index);
          seekToSegment(item.start || 0);
        });
        
        textContainer.appendChild(span);
        
        if (currentAlignmentMode === 'segments' && index < data.length - 1) {
          textContainer.appendChild(document.createTextNode(' '));
        }
      });
    }

    function selectSegment(index) {
      currentSegmentIndex = index;
      renderAlignmentVisualization();
    }

    function seekToSegment(time) {
      if (wavesurfer && wavesurfer.getDuration()) {
        wavesurfer.seekTo(time / wavesurfer.getDuration());
      }
    }

    function playAlignmentSegment() {
      if (!alignmentData || !wavesurfer) {
        console.log('Cannot play: missing data or wavesurfer');
        return;
      }

      const data = currentAlignmentMode === 'segments' ? alignmentData.segments : alignmentData.words;
      
      // ì¸ë±ìŠ¤ ìœ íš¨ì„± ê²€ì‚¬ ì¶”ê°€
      if (!data || currentSegmentIndex < 0 || currentSegmentIndex >= data.length) {
        console.log('Invalid segment index:', currentSegmentIndex);
        return;
      }
      
      const segment = data[currentSegmentIndex];
      
      if (segment && segment.start !== undefined) {
        const startTime = segment.start || 0;
        const endTime = segment.end || startTime + 1;
        
        console.log(`Playing segment from ${startTime}s to ${endTime}s`);
        
        // WaveSurfer ìƒíƒœ í™•ì¸ ì¶”ê°€
        if (wavesurfer.getDuration() > 0) {
          wavesurfer.seekTo(startTime / wavesurfer.getDuration());
          wavesurfer.play();
          
          // ê¸°ì¡´ íƒ€ì´ë¨¸ê°€ ìˆë‹¤ë©´ í´ë¦¬ì–´
          if (window.segmentTimer) {
            clearTimeout(window.segmentTimer);
          }
          
          // ì„¸ê·¸ë¨¼íŠ¸ ëì—ì„œ ì •ì§€
          window.segmentTimer = setTimeout(() => {
            if (wavesurfer && wavesurfer.isPlaying()) {
              wavesurfer.pause();
            }
          }, (endTime - startTime) * 1000);
        } else {
          console.log('Audio not ready or duration is 0');
        }
      } else {
        console.log('Invalid segment data:', segment);
      }
    }

    function pauseAlignment() {
      if (wavesurfer && wavesurfer.isPlaying()) {
        wavesurfer.pause();
      }
      
      // íƒ€ì´ë¨¸ë„ í´ë¦¬ì–´
      if (window.segmentTimer) {
        clearTimeout(window.segmentTimer);
        window.segmentTimer = null;
      }
    }

    function changeAlignmentMode() {
      const select = document.getElementById('alignmentModeSelect');
      if (select) {
        currentAlignmentMode = select.value;
        currentSegmentIndex = 0; // ëª¨ë“œ ë³€ê²½ ì‹œ ì²« ë²ˆì§¸ ì„¸ê·¸ë¨¼íŠ¸ë¡œ ì´ˆê¸°í™”
        renderAlignmentVisualization();
      }
    }

    // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ íƒ€ì´ë¨¸ ì •ë¦¬
    window.addEventListener('beforeunload', function() {
      if (window.segmentTimer) {
        clearTimeout(window.segmentTimer);
      }
    });
  </script>
</body>
</html>
