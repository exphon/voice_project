<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>{{ category_name }} - íŠ¹ìˆ˜í™”ì ìŒì„± ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <!-- Bootstrap CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- FontAwesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 40px;
    }

    .header-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      flex: 1;
      min-width: 0;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    h1 {
      margin: 0;
      margin-right: 10px;
      flex-shrink: 1;
    }

    .home-button {
      color: #0d6efd !important;
      border: 1px solid #0d6efd;
      background-color: transparent;
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 8px;
      text-decoration: none !important;
      transition: all 0.3s ease;
      display: flex !important;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
      min-width: fit-content;
    }
    
    .home-button:hover {
      color: white !important;
      background-color: #0d6efd;
      border-color: #0d6efd;
      text-decoration: none !important;
      transform: translateY(-1px);
    }
    
    .logout-button {
      background-color: #444;
      color: white !important;
      padding: 8px 16px;
      font-size: 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none !important;
      transition: background-color 0.3s ease;
      display: flex !important;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
      min-width: fit-content;
    }

    .logout-button:hover {
      background-color: #222;
      color: white !important;
      text-decoration: none !important;
    }

    .button-row {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    table th, table td {
      border: 1px solid #ccc;
      padding: 10px;
      vertical-align: top;
    }

    table thead {
      background-color: #f2f2f2;
    }

    .pagination {
      margin-top: 20px;
      text-align: center;
    }

    .pagination a {
      margin: 0 10px;
      text-decoration: none;
    }

    .btn-edit {
      background-color: #6c757d;
      color: white;
      text-decoration: none;
      border: 1px solid #6c757d;
      padding: 5px 10px;
      border-radius: 4px;
      display: inline-block;
      transition: all 0.3s ease;
    }

    .btn-edit:hover {
      background-color: #5a6268;
      border-color: #5a6268;
      color: white;
      text-decoration: none;
    }

    .sortable-header {
      cursor: pointer;
      user-select: none;
      position: relative;
      color: #333 !important;
    }

    .sortable-header:hover {
      background-color: #1e3a8a !important;
      color: white !important;
    }

    .sort-arrow {
      margin-left: 5px;
      font-size: 16px;
      font-weight: bold;
    }

    .sort-arrow::after {
      content: "â‡…";
      color: #aaa;
    }

    .sort-arrow.asc::after {
      content: "â–²";
      color: #333;
    }

    .sort-arrow.desc::after {
      content: "â–¼";
      color: #333;
    }

    .audio-cell {
      min-width: 200px;
      max-width: 250px;
    }
    
    .custom-audio-player {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 5px;
      background-color: #f8f9fa;
      border-radius: 5px;
      border: 1px solid #dee2e6;
    }
    
    .play-button {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    
    .play-button:hover {
      background-color: #0056b3;
    }
    
    .audio-info {
      flex: 1;
      font-size: 12px;
      color: #6c757d;
    }

    audio::-webkit-media-controls-panel {
      display: none !important;
    }
  </style>

  <script>
    let currentAudio = null;
    let currentButton = null;

    function toggleAudio(button, audioUrl, index) {
        const audio = document.getElementById(`audio-${index}`);
        const icon = document.getElementById(`icon-${index}`);
        
        if (currentAudio && currentAudio !== audio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
            resetButton(getCurrentAudioIndex());
        }
        
        if (audio.paused) {
            audio.src = audioUrl;
            audio.play().then(() => {
                icon.className = 'fas fa-pause';
                button.disabled = false;
                currentAudio = audio;
                currentButton = button;
            }).catch((error) => {
                console.error('ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', error);
                alert('ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì¬ìƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            });
        } else {
            audio.pause();
            audio.currentTime = 0;
            resetButton(index);
        }
    }
    
    function resetButton(index) {
        const icon = document.getElementById(`icon-${index}`);
        const button = icon.parentElement;
        
        if (icon) {
            icon.className = 'fas fa-play';
        }
        if (button) {
            button.disabled = false;
        }
        
        if (currentAudio) {
            currentAudio = null;
            currentButton = null;
        }
    }
    
    function getCurrentAudioIndex() {
        if (currentAudio) {
            const id = currentAudio.id;
            return parseInt(id.split('-')[1]);
        }
        return -1;
    }

    function formatDuration(seconds) {
        if (!seconds || seconds === 0) return '0:00';
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    function loadAudioDuration(index) {
        const audio = document.getElementById(`audio-${index}`);
        const durationElement = document.getElementById(`duration-${index}`);
        
        if (audio && durationElement) {
            const updateDuration = () => {
                if (audio.duration && !isNaN(audio.duration)) {
                    durationElement.textContent = formatDuration(audio.duration);
                }
            };

            if (audio.duration && !isNaN(audio.duration)) {
                updateDuration();
            } else {
                audio.addEventListener('loadedmetadata', updateDuration);
                audio.addEventListener('durationchange', updateDuration);
            }
        }
    }

    window.addEventListener('load', function() {
        const audioElements = document.querySelectorAll('audio[id^="audio-"]');
        audioElements.forEach((audio, index) => {
            const actualIndex = audio.id.split('-')[1];
            loadAudioDuration(actualIndex);
        });
    });
    
    window.addEventListener('beforeunload', function() {
        if (currentAudio) {
            currentAudio.pause();
            currentAudio = null;
        }
    });
    
    function sortTable(field) {
        const currentSort = '{{ current_sort }}';
        const currentIdentifier = '{{ current_identifier }}';
        let newSort = field;
        
        if (currentSort === field) {
            newSort = '-' + field;
        }
        
        const url = new URL(window.location);
        url.searchParams.set('sort', newSort);
        url.searchParams.delete('page');
        
        // identifier í•„í„° ìœ ì§€
        if (currentIdentifier && currentIdentifier !== 'None') {
            url.searchParams.set('identifier', currentIdentifier);
        }
        
        window.location.href = url.toString();
    }
  </script>
</head>
<body>
  <!-- í—¤ë” ì„¹ì…˜ -->
  <div class="header-section">
    <div class="header-left">
      <h1>ğŸ“‚ {{ category_name }} ìŒì„± ë°ì´í„° ëª©ë¡</h1>
      
      <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
          ì¹´í…Œê³ ë¦¬ ì„ íƒ
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="{% url 'audio_list' %}">ì „ì²´ ë³´ê¸°</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="/voice/child/list/">ì•„ë™</a></li>
          <li><a class="dropdown-item" href="/voice/senior/list/">ë…¸ì¸</a></li>
          <li><a class="dropdown-item" href="/voice/atypical/list/">ìŒì„± ì¥ì• </a></li>
          <li><a class="dropdown-item" href="/voice/auditory/list/">ì²­ê° ì¥ì• </a></li>
          <li><a class="dropdown-item" href="/voice/normal/list/">ì¼ë°˜</a></li>
        </ul>
      </div>
    </div>

    <div class="header-right">
      <a href="/" class="home-button">
        <i class="fas fa-home"></i>í™ˆ
      </a>
      
      <a href="/accounts/logout/" class="logout-button">
        <i class="fas fa-sign-out-alt"></i>ë¡œê·¸ì•„ì›ƒ
      </a>
    </div>
  </div>

  <!-- í•„í„° ìƒíƒœ í‘œì‹œ -->
  {% if current_identifier %}
  <div style="margin: 20px 0; padding: 15px; background-color: #e3f2fd; border-left: 4px solid #003366; border-radius: 4px;">
    <strong style="color: #003366;">
      <i class="fas fa-filter"></i> í•„í„°ë§ ì¤‘:
    </strong>
    <span style="font-weight: bold; color: #003366;">ê³ ìœ  ID = {{ current_identifier }}</span>
    <a href="?category={{ category }}" style="margin-left: 15px; color: #d32f2f; text-decoration: none;">
      <i class="fas fa-times-circle"></i> í•„í„° í•´ì œ
    </a>
  </div>
  {% endif %}

  <!-- íŒŒì¼ ëª©ë¡ í…Œì´ë¸” -->
  <table>
    <thead>
      <tr>
        <th class="sortable-header" onclick="sortTable('id')">
          ë²ˆí˜¸
          <span class="sort-arrow {% if current_sort == 'id' %}asc{% elif current_sort == '-id' %}desc{% endif %}"></span>
        </th>
        <th class="sortable-header" onclick="sortTable('identifier')">
          ê³ ìœ  ID
          <span class="sort-arrow {% if current_sort == 'identifier' %}asc{% elif current_sort == '-identifier' %}desc{% endif %}"></span>
        </th>
        <th>ìŒì„± íŒŒì¼</th>
        <th class="sortable-header" onclick="sortTable('name')">
          ì´ë¦„
          <span class="sort-arrow {% if current_sort == 'name' %}asc{% elif current_sort == '-name' %}desc{% endif %}"></span>
        </th>
        <th class="sortable-header" onclick="sortTable('gender')">
          ì„±ë³„
          <span class="sort-arrow {% if current_sort == 'gender' %}asc{% elif current_sort == '-gender' %}desc{% endif %}"></span>
        </th>
        <th class="sortable-header" onclick="sortTable('age')">
          ë‚˜ì´
          <span class="sort-arrow {% if current_sort == 'age' %}asc{% elif current_sort == '-age' %}desc{% endif %}"></span>
        </th>
        <th class="sortable-header" onclick="sortTable('task_type')">
          ê³¼ì œ ìœ í˜•
          <span class="sort-arrow {% if current_sort == 'task_type' %}asc{% elif current_sort == '-task_type' %}desc{% endif %}"></span>
        </th>
        <th class="sortable-header" onclick="sortTable('category')">
          ì¹´í…Œê³ ë¦¬
          <span class="sort-arrow {% if current_sort == 'category' %}asc{% elif current_sort == '-category' %}desc{% endif %}"></span>
        </th>
        <th>ì „ì‚¬ í…ìŠ¤íŠ¸</th>
        <th class="sortable-header" onclick="sortTable('status')">
          ìƒíƒœ / ë‹¤ì‹œ ì „ì‚¬
          <span class="sort-arrow {% if current_sort == 'status' %}asc{% elif current_sort == '-status' %}desc{% endif %}"></span>
        </th>
        <th class="sortable-header" onclick="sortTable('created_at')">
          ì—…ë¡œë“œ ì‹œê°„
          <span class="sort-arrow {% if current_sort == 'created_at' %}asc{% elif current_sort == '-created_at' %}desc{% endif %}"></span>
        </th>
        <th>ì‘ì—…</th>
      </tr>
    </thead>
    <tbody>
      {% for audio in audios %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>
          {% if audio.identifier %}
            <a href="?identifier={{ audio.identifier }}" style="font-weight: bold; color: #003366; text-decoration: none; cursor: pointer;">
              {{ audio.identifier }}
            </a>
          {% else %}
            <span class="text-muted">N/A</span>
          {% endif %}
        </td>
        <td class="audio-cell">
          <div class="custom-audio-player">
            <button class="play-button" onclick="toggleAudio(this, '{{ audio.audio_file.url|escapejs }}', '{{ forloop.counter0 }}')">
              <i class="fas fa-play" id="icon-{{ forloop.counter0 }}"></i>
            </button>
            <div class="audio-info">
              {% if audio.duration %}
                <div>ì¬ìƒì‹œê°„: {{ audio.duration|floatformat:1 }}ì´ˆ</div>
              {% else %}
                <div>ì¬ìƒì‹œê°„: <span id="duration-{{ forloop.counter0 }}">ë¡œë”©ì¤‘...</span></div>
              {% endif %}
            </div>
            <audio id="audio-{{ forloop.counter0 }}" preload="metadata" onended="resetButton('{{ forloop.counter0 }}')">
              <source src="{{ audio.audio_file.url }}" type="audio/mpeg">
              <source src="{{ audio.audio_file.url }}" type="audio/wav">
              <source src="{{ audio.audio_file.url }}" type="audio/ogg">
              ë¸Œë¼ìš°ì €ê°€ ì˜¤ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </audio>
          </div>
        </td>
        <td>
          {% if audio.name %}
            <span title="ì¥ì†Œ: {{ audio.recording_location|default:'ë¯¸ì…ë ¥' }}, ê¸°ê¸°: {{ audio.device_type|default:'ë¯¸ì…ë ¥' }}">
              {{ audio.name }}
            </span>
          {% else %}
            <span style="color: #999; font-style: italic;" title="ì¥ì†Œ: {{ audio.recording_location|default:'ë¯¸ì…ë ¥' }}, ê¸°ê¸°: {{ audio.device_type|default:'ë¯¸ì…ë ¥' }}">
              ë¯¸ì…ë ¥
            </span>
          {% endif %}
        </td>
        <td>
          {% if audio.gender %}
            {{ audio.gender }}
          {% else %}
            <span style="color: #999; font-style: italic;">ë¯¸ì…ë ¥</span>
          {% endif %}
        </td>
        <td>
          {% if audio.age %}
            {{ audio.age }}
          {% else %}
            <span style="color: #999; font-style: italic;">ë¯¸ì…ë ¥</span>
          {% endif %}
        </td>
        <td>
          {% if audio.category_specific_data.task_type %}
            {{ audio.category_specific_data.task_type }}
          {% else %}
            <span style="color: #999; font-style: italic;">ë¯¸ì…ë ¥</span>
          {% endif %}
        </td>
        <td>
          {% if audio.category == 'child' %}
            <span class="badge bg-primary">ì•„ë™</span>
          {% elif audio.category == 'senior' %}
            <span class="badge bg-info">ë…¸ì¸</span>
          {% elif audio.category == 'atypical' %}
            <span class="badge bg-warning">ìŒì„± ì¥ì• </span>
          {% elif audio.category == 'auditory' %}
            <span class="badge bg-success">ì²­ê° ì¥ì• </span>
          {% elif audio.category == 'normal' %}
            <span class="badge bg-secondary">ì¼ë°˜</span>
          {% else %}
            <span class="badge bg-light text-dark">{{ audio.category }}</span>
          {% endif %}
        </td>
        <td>
          {% if audio.manual_transcript %}
            <div style="max-width: 300px; word-wrap: break-word;">
              {{ audio.manual_transcript }}
              {% if audio.manual_transcript != audio.transcript %}
                <span style="color: #666; font-size: 11px;"><i class="fas fa-edit"></i></span>
              {% endif %}
            </div>
          {% elif audio.transcript %}
            <div style="max-width: 300px; word-wrap: break-word;">
              {{ audio.transcript }}
            </div>
          {% else %}
            <span style="color: #999; font-style: italic;">ì „ì‚¬ ëŒ€ê¸°</span>
          {% endif %}
        </td>
        <td>
          <div><strong>ìƒíƒœ:</strong> {{ audio.get_status_display }}</div>

          {% if audio.status != 'processing' %}
            <form method="POST" action="{% url 'transcribe_single_audio' audio.id %}" 
                  style="margin-top: 5px;">
              {% csrf_token %}
              <button type="submit" class="btn btn-transcribe" style="font-size: 12px; padding: 5px 10px; background-color: green;">
                ğŸ§  ë‹¤ì‹œ ì „ì‚¬
              </button>
            </form>
          {% else %}
            <span style="font-size: 12px; color: gray;">â³ ì²˜ë¦¬ ì¤‘...</span>
          {% endif %}
        </td>
        <td>{{ audio.created_at|date:"Y-m-d H:i" }}</td>
        <td>
          <a href="{% url 'audio_detail' audio.id %}" class="btn-edit" title="ìƒì„¸ ì •ë³´ í¸ì§‘">
            <i class="fas fa-edit"></i>
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
  <div class="pagination">
    <span style="margin-right: 10px;">í˜ì´ì§€:</span>
    {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if current_identifier %}&identifier={{ current_identifier }}{% endif %}">â¬… ì´ì „</a>
    {% endif %}

    <span>
      í˜ì´ì§€ {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
    </span>

    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if current_identifier %}&identifier={{ current_identifier }}{% endif %}">ë‹¤ìŒ â¡</a>
    {% endif %}
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
