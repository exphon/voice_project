<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>{{ category_name }} - íŠ¹ìˆ˜í™”ì ìŒì„± ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <!-- Bootstrap CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- FontAwesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 40px;
    }

    .header-section {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      margin-bottom: 20px;
      gap: 10px;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      flex: 1;
      min-width: 0;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    .header-search {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: flex-start;
      min-width: 280px;
    }

    /* í—¤ë” ê²€ìƒ‰ í¼ì´ 'ì¹´í…Œê³ ë¦¬ ì„ íƒ', 'í™ˆ' ë²„íŠ¼ê³¼ ê°™ì€ ë†’ì´/ì •ë ¬ì´ ë˜ë„ë¡ í†µì¼ */
    .header-search form {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-start;
      margin: 0;
    }

    .header-search .form-control,
    .header-search .form-select,
    .header-search .btn {
      height: 38px;
      font-size: 14px;
    }

    .header-search .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }

    h1 {
      margin: 0;
      flex-shrink: 1;
    }

    .home-button {
      color: #0d6efd !important;
      border: 1px solid #0d6efd;
      background-color: transparent;
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 8px;
      text-decoration: none !important;
      transition: all 0.3s ease;
      display: flex !important;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
      min-width: fit-content;
    }
    
    .home-button:hover {
      color: white !important;
      background-color: #0d6efd;
      border-color: #0d6efd;
      text-decoration: none !important;
      transform: translateY(-1px);
    }
    
    .logout-button {
      background-color: #444;
      color: white !important;
      padding: 8px 16px;
      font-size: 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none !important;
      transition: background-color 0.3s ease;
      display: flex !important;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
      min-width: fit-content;
    }

    .logout-button:hover {
      background-color: #222;
      color: white !important;
      text-decoration: none !important;
    }

    .button-row {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }

    .btn-transcribe {
      background-color: green;
    }

    .btn-save {
      background-color: dodgerblue;
      padding: 6px 12px;
      font-size: 12px;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }

    textarea {
      width: 100%;
      resize: vertical;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    table th, table td {
      border: 1px solid #ccc;
      padding: 10px;
      vertical-align: top;
    }

    table thead {
      background-color: #f2f2f2;
    }

    .pagination {
      margin-top: 20px;
      text-align: center;
    }

    .pagination a {
      margin: 0 10px;
      text-decoration: none;
    }

    .btn-edit {
      background-color: #6c757d;
      color: white;
      text-decoration: none;
      border: 1px solid #6c757d;
      padding: 5px 10px;
      border-radius: 4px;
      display: inline-block;
      transition: all 0.3s ease;
    }

    .btn-edit:hover {
      background-color: #5a6268;
      border-color: #5a6268;
      color: white;
      text-decoration: none;
    }

    .sortable-header {
      cursor: pointer;
      user-select: none;
      position: relative;
      color: #333 !important;
    }

    .sortable-header:hover {
      background-color: #1e3a8a !important;
      color: white !important;
    }

    .sort-arrow {
      margin-left: 5px;
      font-size: 16px;
      font-weight: bold;
    }

    .sort-arrow::after {
      content: "â‡…";
      color: #aaa;
    }

    .sort-arrow.asc::after {
      content: "â–²";
      color: #333;
    }

    .sort-arrow.desc::after {
      content: "â–¼";
      color: #333;
    }

    .audio-cell {
      min-width: 200px;
      max-width: 250px;
    }

    /* ì»¬ëŸ¼ ë„ˆë¹„ ì¡°ì •: í™”ì ë„“ê²Œ, ì—…ë¡œë“œ ì‹œê°„ ì¢ê²Œ */
    #speaker-count-header,
    td.speaker-count-cell {
      min-width: 90px;
      width: 90px;
      text-align: center;
      white-space: nowrap;
    }

    th.created-at-col,
    td.created-at-col {
      width: 120px;
      max-width: 120px;
      white-space: normal;
      line-height: 1.15;
    }

    td.created-at-col .date-part,
    td.created-at-col .time-part {
      display: inline-block;
      white-space: nowrap;
    }
    
    .custom-audio-player {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 5px;
      background-color: #f8f9fa;
      border-radius: 5px;
      border: 1px solid #dee2e6;
    }
    
    .play-button {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    
    .play-button:hover {
      background-color: #0056b3;
    }
    
    .audio-info {
      flex: 1;
      font-size: 12px;
      color: #6c757d;
    }

    audio::-webkit-media-controls-panel {
      display: none !important;
    }
  </style>

  <script>
    let currentAudio = null;
    let currentButton = null;

    function toggleAudio(button, audioUrl, index) {
        const audio = document.getElementById(`audio-${index}`);
        const icon = document.getElementById(`icon-${index}`);
        
        if (currentAudio && currentAudio !== audio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
            resetButton(getCurrentAudioIndex());
        }
        
        if (audio.paused) {
            audio.src = audioUrl;
            audio.play().then(() => {
                icon.className = 'fas fa-pause';
                button.disabled = false;
                currentAudio = audio;
                currentButton = button;
            }).catch((error) => {
                console.error('ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', error);
                alert('ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì¬ìƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            });
        } else {
            audio.pause();
            audio.currentTime = 0;
            resetButton(index);
        }
    }
    
    function resetButton(index) {
        const icon = document.getElementById(`icon-${index}`);
        const button = icon.parentElement;
        
        if (icon) {
            icon.className = 'fas fa-play';
        }
        if (button) {
            button.disabled = false;
        }
        
        if (currentAudio) {
            currentAudio = null;
            currentButton = null;
        }
    }
    
    function getCurrentAudioIndex() {
        if (currentAudio) {
            const id = currentAudio.id;
            return parseInt(id.split('-')[1]);
        }
        return -1;
    }

    function formatDuration(seconds) {
        if (!seconds || seconds === 0) return '0:00';
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    function loadAudioDuration(index) {
        const audio = document.getElementById(`audio-${index}`);
        const durationElement = document.getElementById(`duration-${index}`);
        
        if (audio && durationElement) {
            const updateDuration = () => {
                if (audio.duration && !isNaN(audio.duration)) {
                    durationElement.textContent = formatDuration(audio.duration);
                }
            };

            if (audio.duration && !isNaN(audio.duration)) {
                updateDuration();
            } else {
                audio.addEventListener('loadedmetadata', updateDuration);
                audio.addEventListener('durationchange', updateDuration);
            }
        }
    }

    window.addEventListener('load', function() {
        const audioElements = document.querySelectorAll('audio[id^="audio-"]');
        audioElements.forEach((audio, index) => {
            const actualIndex = audio.id.split('-')[1];
            loadAudioDuration(actualIndex);
        });
    });
    
    window.addEventListener('beforeunload', function() {
        if (currentAudio) {
            currentAudio.pause();
            currentAudio = null;
        }
    });

    function stayHere() {
      return true;
    }
    
    function sortTable(field) {
        const currentSort = '{{ current_sort }}';
        let newSort = field;
        
        if (currentSort === field) {
            newSort = '-' + field;
        }
        
        const url = new URL(window.location);
        url.searchParams.set('sort', newSort);
        url.searchParams.delete('page');

        window.location.href = url.toString();
    }
  </script>
</head>
<body>
  <!-- í—¤ë” ì„¹ì…˜ -->
  <div class="header-section">
    <div>
      <h1>ğŸ“‚ {{ category_name }} ìŒì„± ë°ì´í„° ëª©ë¡</h1>
    </div>

    <div class="header-row">
      <div class="header-left">
        <form method="POST" action="{% url 'voice_app:transcribe_unprocessed_category' category=category %}" style="margin: 0;">
          {% csrf_token %}
          <button 
            type="submit"
            class="btn btn-transcribe"
            onclick="return confirm('ì „ì‚¬ë˜ì§€ ì•Šì€ {{ category_name }} íŒŒì¼ì„ Whisperë¡œ ì „ì‚¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"
          >
            ğŸ§  Whisper ì „ì‚¬ ì‹¤í–‰
          </button>
        </form>

        <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
            ì¹´í…Œê³ ë¦¬ ì„ íƒ
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="{% url 'voice_app:audio_list' %}">ì „ì²´ ë³´ê¸°</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="/voice/child/list/">ì•„ë™ ë§ê³¼ì œ</a></li>
            <li><a class="dropdown-item" href="/voice/senior/list/">ì¥ë…¸ë…„ ë§ê³¼ì œ</a></li>
            <li><a class="dropdown-item" href="/voice/auditory/list/">ì²­ê° ë§ê³¼ì œ</a></li>
          </ul>
        </div>

        <!-- ê²€ìƒ‰ í¼: 'ì¹´í…Œê³ ë¦¬ ì„ íƒ' ë°”ë¡œ ì˜† -->
        <div class="header-search">
          <form method="GET" action="">
            {% if current_sort %}
              <input type="hidden" name="sort" value="{{ current_sort|urlencode }}">
            {% endif %}
            {% if current_identifier %}
              <input type="hidden" name="identifier" value="{{ current_identifier|urlencode }}">
            {% endif %}

            <input type="text" name="name" value="{{ current_name|default:'' }}" placeholder="ì´ë¦„ ê²€ìƒ‰" class="form-control" style="width: 160px;">
            <input type="text" name="age" value="{{ current_age|default:'' }}" placeholder="ë‚˜ì´(ì •í™•íˆ)" class="form-control" style="width: 120px;">

            <select name="task_type" class="form-select" style="width: 180px;">
              <option value="">ê³¼ì œ ìœ í˜• ì„ íƒ</option>
              {% for tt in task_type_options %}
                <option value="{{ tt }}" {% if current_task_type == tt %}selected{% endif %}>{{ tt }}</option>
              {% endfor %}
            </select>

            <button type="submit" class="btn btn-primary">
              <i class="fas fa-search me-1"></i>ê²€ìƒ‰
            </button>

            <a href="{% url 'voice_app:category_audio_list' category=category %}" class="btn btn-outline-secondary">
              ì´ˆê¸°í™”
            </a>
          </form>
        </div>
      </div>

      <div class="header-right">
        <a href="/" class="home-button">
          <i class="fas fa-home"></i>í™ˆ
        </a>
        
        <a href="/accounts/logout/" class="logout-button">
          <i class="fas fa-sign-out-alt"></i>ë¡œê·¸ì•„ì›ƒ
        </a>
      </div>
    </div>
  </div>

  <!-- í•„í„° ìƒíƒœ í‘œì‹œ -->
  {% if current_identifier or current_name or current_age or current_task_type %}
  <div style="margin: 20px 0; padding: 15px; background-color: #e3f2fd; border-left: 4px solid #003366; border-radius: 4px;">
    <strong style="color: #003366;">
      <i class="fas fa-filter"></i> í•„í„°ë§ ì¤‘:
    </strong>
    {% if current_identifier %}
      <span style="font-weight: bold; color: #003366;">ê³ ìœ  ID = {{ current_identifier }}</span>
    {% endif %}
    {% if current_name %}
      <span style="margin-left: 10px; font-weight: bold; color: #003366;">ì´ë¦„ í¬í•¨ = {{ current_name }}</span>
    {% endif %}
    {% if current_age %}
      <span style="margin-left: 10px; font-weight: bold; color: #003366;">ë‚˜ì´ = {{ current_age }}</span>
    {% endif %}
    {% if current_task_type %}
      <span style="margin-left: 10px; font-weight: bold; color: #003366;">ê³¼ì œ ìœ í˜• = {{ current_task_type }}</span>
    {% endif %}
    <a href="{% url 'voice_app:category_audio_list' category=category %}" style="margin-left: 15px; color: #d32f2f; text-decoration: none;">
      <i class="fas fa-times-circle"></i> í•„í„° í•´ì œ
    </a>
  </div>
  {% endif %}

  <!-- íŒŒì¼ ëª©ë¡ í…Œì´ë¸” -->
  <table>
    <thead>
      <tr>
        <th class="sortable-header" onclick="sortTable('id')">
          ë²ˆí˜¸
          <span class="sort-arrow {% if current_sort == 'id' %}asc{% elif current_sort == '-id' %}desc{% endif %}"></span>
        </th>
        <th id="speaker-count-header" class="sortable-header" onclick="sortTable('speaker')" title="identifier + ì´ë¦„ + ì„±ë³„ + ë‚˜ì´ê°€ ê°™ìœ¼ë©´ ë™ì¼ í™”ìë¡œ ê³„ì‚° (í•„í„°/ì •ë ¬ëœ ì „ì²´ ê²°ê³¼ ê¸°ì¤€)">
          í™”ì
          <span class="sort-arrow {% if current_sort == 'speaker' %}asc{% elif current_sort == '-speaker' %}desc{% endif %}"></span>
          <br>(ì´ {{ speaker_total }}ëª…)
        </th>
        <th class="sortable-header" onclick="sortTable('identifier')">
          ê³ ìœ  ID
          <span class="sort-arrow {% if current_sort == 'identifier' %}asc{% elif current_sort == '-identifier' %}desc{% endif %}"></span>
        </th>
        <th>ìŒì„± íŒŒì¼</th>
        <th class="sortable-header" onclick="sortTable('name')">
          ì´ë¦„
          <span class="sort-arrow {% if current_sort == 'name' %}asc{% elif current_sort == '-name' %}desc{% endif %}"></span>
        </th>
        <th class="sortable-header" onclick="sortTable('gender')">
          ì„±ë³„
          <span class="sort-arrow {% if current_sort == 'gender' %}asc{% elif current_sort == '-gender' %}desc{% endif %}"></span>
        </th>
        <th class="sortable-header" onclick="sortTable('age')">
          ë‚˜ì´
          <span class="sort-arrow {% if current_sort == 'age' %}asc{% elif current_sort == '-age' %}desc{% endif %}"></span>
        </th>
        <th class="sortable-header" onclick="sortTable('task_type')">
          ê³¼ì œ ìœ í˜•
          <span class="sort-arrow {% if current_sort == 'task_type' %}asc{% elif current_sort == '-task_type' %}desc{% endif %}"></span>
        </th>
        <th class="sortable-header" onclick="sortTable('category')">
          ì¹´í…Œê³ ë¦¬
          <span class="sort-arrow {% if current_sort == 'category' %}asc{% elif current_sort == '-category' %}desc{% endif %}"></span>
        </th>
        <th>ì¸ì‹ ê²°ê³¼ (í¸ì§‘ ê°€ëŠ¥)</th>
        <th class="sortable-header created-at-col" onclick="sortTable('created_at')">
          ì—…ë¡œë“œ ì‹œê°„
          <span class="sort-arrow {% if current_sort == 'created_at' %}asc{% elif current_sort == '-created_at' %}desc{% endif %}"></span>
        </th>
        <th>ì‘ì—…</th>
      </tr>
    </thead>
    <tbody>
      {% for audio in audios %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td class="speaker-count-cell">{{ audio.speaker_index }}</td>
        <td>
          {% if audio.identifier %}
            <a href="?identifier={{ audio.identifier }}" style="font-weight: bold; color: #003366; text-decoration: none; cursor: pointer;">
              {{ audio.identifier }}
            </a>
          {% else %}
            <span class="text-muted">N/A</span>
          {% endif %}
        </td>
        <td class="audio-cell">
          <div class="custom-audio-player">
            <button class="play-button" onclick="toggleAudio(this, '{{ audio.audio_file.url|escapejs }}', '{{ forloop.counter0 }}')">
              <i class="fas fa-play" id="icon-{{ forloop.counter0 }}"></i>
            </button>
            <div class="audio-info">
              {% if audio.duration %}
                <div>ì¬ìƒì‹œê°„: {{ audio.duration|floatformat:1 }}ì´ˆ</div>
              {% else %}
                <div>ì¬ìƒì‹œê°„: <span id="duration-{{ forloop.counter0 }}">ë¡œë”©ì¤‘...</span></div>
              {% endif %}
            </div>
            <audio id="audio-{{ forloop.counter0 }}" preload="metadata" onended="resetButton('{{ forloop.counter0 }}')">
              <source src="{{ audio.audio_file.url }}" type="audio/mpeg">
              <source src="{{ audio.audio_file.url }}" type="audio/wav">
              <source src="{{ audio.audio_file.url }}" type="audio/ogg">
              ë¸Œë¼ìš°ì €ê°€ ì˜¤ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </audio>
          </div>
        </td>
        <td>
          {% if audio.name %}
            <span title="ì¥ì†Œ: {{ audio.recording_location|default:'ë¯¸ì…ë ¥' }}, ê¸°ê¸°: {{ audio.device_type|default:'ë¯¸ì…ë ¥' }}">
              {{ audio.name }}
            </span>
          {% else %}
            <span style="color: #999; font-style: italic;" title="ì¥ì†Œ: {{ audio.recording_location|default:'ë¯¸ì…ë ¥' }}, ê¸°ê¸°: {{ audio.device_type|default:'ë¯¸ì…ë ¥' }}">
              ë¯¸ì…ë ¥
            </span>
          {% endif %}
        </td>
        <td>
          {% if audio.gender %}
            {{ audio.gender }}
          {% else %}
            <span style="color: #999; font-style: italic;">ë¯¸ì…ë ¥</span>
          {% endif %}
        </td>
        <td>
          {% if audio.age %}
            {{ audio.age }}
          {% else %}
            <span style="color: #999; font-style: italic;">ë¯¸ì…ë ¥</span>
          {% endif %}
        </td>
        <td>
          {% if audio.category_specific_data.task_type %}
            {{ audio.category_specific_data.task_type }}
          {% else %}
            <span style="color: #999; font-style: italic;">ë¯¸ì…ë ¥</span>
          {% endif %}
        </td>
        <td>
          {% if audio.category == 'child' %}
            <span class="badge bg-primary">ì•„ë™</span>
          {% elif audio.category == 'senior' %}
            <span class="badge bg-info">ì„±ì¸</span>
          {% elif audio.category == 'atypical' %}
            <span class="badge bg-warning">ìŒì„± ì¥ì• </span>
          {% elif audio.category == 'auditory' %}
            <span class="badge bg-success">ì²­ê° ì¥ì• </span>
          {% elif audio.category == 'normal' %}
            <span class="badge bg-secondary">ì¼ë°˜</span>
          {% else %}
            <span class="badge bg-light text-dark">{{ audio.category }}</span>
          {% endif %}
        </td>
        <td>
          <form method="POST" action="{% url 'voice_app:update_transcription' audio.id %}" onsubmit="return stayHere();">
            {% csrf_token %}
            <textarea name="manual_transcript" rows="2">{{ audio.manual_transcript_display|default:audio.transcript_display|default_if_none:"" }}</textarea>
            <button type="submit" class="btn btn-save">ğŸ’¾ ì €ì¥</button>
          </form>
        </td>
        <td class="created-at-col">
          <span class="date-part">{{ audio.created_at|date:"Y-m-d" }}</span><br>
          <span class="time-part">{{ audio.created_at|date:"H:i" }}</span>
        </td>
        <td>
          <a href="{% url 'voice_app:audio_detail' audio.id %}" class="btn-edit" title="ìƒì„¸ ì •ë³´ í¸ì§‘">
            <i class="fas fa-edit"></i>
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
  <div class="pagination">
    <div style="display: inline-flex; align-items: center; gap: 6px; flex-wrap: wrap; justify-content: center;">
      <!-- ì²˜ìŒ/ì´ì „ -->
      {% if page_obj.has_previous %}
        <a href="?page=1{% if query_string %}&{{ query_string }}{% endif %}" title="ì²˜ìŒ">â®</a>
        <a href="?page={{ prev_jump_page }}{% if query_string %}&{{ query_string }}{% endif %}" title="ì´ì „">â—€</a>
      {% else %}
        <span style="color: #bbb;">â®</span>
        <span style="color: #bbb;">â—€</span>
      {% endif %}

      <!-- í˜ì´ì§€ ë²ˆí˜¸ 10ê°œ -->
      {% for p in page_numbers %}
        {% if p == page_obj.number %}
          <span style="display:inline-block; min-width: 34px; padding: 6px 10px; border: 1px solid #0d6efd; border-radius: 6px; background:#0d6efd; color:#fff; font-weight: 600;">{{ p }}</span>
        {% else %}
          <a href="?page={{ p }}{% if query_string %}&{{ query_string }}{% endif %}" style="display:inline-block; min-width: 34px; padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px;">{{ p }}</a>
        {% endif %}
      {% endfor %}

      <!-- ë‹¤ìŒ/ë -->
      {% if page_obj.has_next %}
        <a href="?page={{ next_jump_page }}{% if query_string %}&{{ query_string }}{% endif %}" title="ë‹¤ìŒ">â–¶</a>
        <a href="?page={{ page_obj.paginator.num_pages }}{% if query_string %}&{{ query_string }}{% endif %}" title="ë">â­</a>
      {% else %}
        <span style="color: #bbb;">â–¶</span>
        <span style="color: #bbb;">â­</span>
      {% endif %}

      <span style="margin-left: 6px; color: #666;">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
